<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊãìÁ´πËøûÁª≠ÊâìÂç∞ÈòüÂàóÁîüÊàê</title>
    <style>
        .download-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 5000; /* ÊèêÂçáÂà∞ÊúÄÈ°∂Â±ÇÔºåÁ°Æ‰øùÈ´ò‰∫é processing-modal */
            align-items: center;
            justify-content: center;
        }

        .download-modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .download-modal-title {
            font-size: 1.5em;
            color: #3498db;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .download-modal-message {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .download-progress-container {
            margin: 20px 0;
        }

        .download-progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .download-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #27ae60, #219a52);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .download-progress-details {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
            margin-top: 10px;
        }

        .download-progress-file {
            font-weight: 600;
            color: #2c3e50;
        }

        .download-progress-percentage {
            font-weight: 600;
            color: #27ae60;
        }

        .download-progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 0.85em;
            color: #495057;
        }

        /* ÊâπÈáè‰∏ãËΩΩÂºπÁ™óÊ†∑Âºè */
        .batch-download-modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .batch-download-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .batch-download-file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            text-align: left;
        }

        .batch-download-file-item {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .batch-download-file-item:last-child {
            border-bottom: none;
        }

        .batch-download-file-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .batch-download-file-size {
            color: #6c757d;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .batch-download-overall-progress {
            margin: 20px 0;
        }

        .batch-download-file-progress {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        /* ËøõÂ∫¶Êù°Ê†∑Âºè */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .progress-details {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
            line-height: 1.4;
        }

        .progress-file {
            font-weight: 600;
            color: #2c3e50;
        }

        .progress-percentage {
            font-weight: 600;
            color: #3498db;
        }

        /* Â§ÑÁêÜ‰∏≠ÂºπÁ™óÊ†∑Âºè */
        .processing-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .processing-modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .processing-modal-title {
            font-size: 1.5em;
            color: #3498db;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .processing-modal-message {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        /* ÈîôËØØÂºπÁ™óÊ†∑Âºè */
        .error-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .error-modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .error-modal-title {
            font-size: 1.5em;
            color: #e74c3c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .error-modal-message {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .error-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .error-modal-button {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .error-modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        /* ÊàêÂäüÂºπÁ™óÊ†∑Âºè */
        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .success-modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        .success-modal-title {
            font-size: 1.5em;
            color: #27ae60;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .success-modal-message {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .success-modal-button {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .success-modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .success-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        /* Â§çÂà∂YAMLÊåâÈíÆÊ†∑Âºè - Â∞èÂûãÊ¨°Ë¶ÅÊåâÈíÆ */
        .btn-copy-yaml {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 160px;
        }

        .btn-copy-yaml:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-1px);
        }

        .btn-copy-yaml.copied {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1em;
        }
        
        .content {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .section-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 32px;
        }
        
        .section-title .file-count {
            font-size: 0.75em;
            color: #6c757d;
            font-weight: normal;
            margin-left: 6px;
        }

        .server-section .section-title {
            margin-bottom: 8px;
        }
        
        .config-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }
        
        input, select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        
        .file-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .server-file-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.3s ease;
        }
        
        .file-item:hover {
            background: #f8f9fa;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-checkbox {
            margin-right: 12px;
        }
        
        .server-file-checkbox {
            margin-right: 12px;
        }

        .file-info {
            flex: 1;
            cursor: pointer;
        }
        
        .file-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 0.95em;
        }
        
        .file-details {
            display: flex;
            gap: 12px;
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .file-actions {
            display: flex;
            gap: 6px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            display: none;
            font-size: 0.9em;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .result-item {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            background: #f8f9fa;
            font-size: 0.85em;
        }
        
        .result-success {
            border-left: 3px solid #28a745;
        }
        
        .result-error {
            border-left: 3px solid #dc3545;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        .selected-count {
            font-size: 0.9em;
            color: #e8f5e9;
            margin-left: 6px;
            font-weight: normal;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Êñá‰ª∂ÂêçÊèêÁ§∫Ê†∑Âºè */
        .filename-hint {
            font-size: 0.75em;
            color: #6c757d;
            margin-left: 8px;
            font-weight: normal;
        }

        /* Â∫ïÈÉ®ÊåâÈíÆÂå∫Âüü */
        .footer {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .footer-center {
            flex: 1;
            display: flex;
            justify-content: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .footer-right {
            width: 165px;
            margin-right: 16px;
        }

        .footer-btn-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .footer-btn {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
            min-width: 150px;
        }

        .footer-btn-wide {
            min-width: 250px;
            padding: 12px 50px;
            font-size: 18px;
        }

        /* ÈÖçÁΩÆÂºπÁ™óÊ†∑Âºè */
        .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .config-modal-content {
            background: white;
            margin: 30px auto;
            padding: 0;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .config-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .config-modal-title {
            font-size: 1.5em;
            color: #2c3e50;
            flex: 1;
        }

        .close {
            font-size: 1.8em;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .config-modal-body {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .config-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .config-section-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3498db;
        }

        .config-modal-footer {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-top: 2px solid #e9ecef;
            gap: 15px;
        }

        /* ÊâìÂç∞ÈòüÂàóÂºπÁ™óÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow: hidden;
        }

        .modal-content {
            background: white;
            margin: 30px auto;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 1300px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
            position: sticky;
            top: -20px;
            background: white;
            z-index: 10;
            margin: -20px -20px 20px -20px;
            box-shadow: none;
        }

        .modal-title {
            font-size: 1.8em;
            color: #2c3e50;
            flex: 1;
        }

        .quick-config-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-right: 20px;
        }

        .quick-config-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-right: 10px;
        }

        .quick-config-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .quick-config-item label {
            font-size: 0.8em;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }

        .switch-header {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch-header input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-header {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider-header:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider-header {
            background-color: #2196F3;
        }

        input:checked + .slider-header:before {
            transform: translateX(20px);
        }

        /* ÊâìÂç∞ÈòüÂàóÂºπÁ™óÂ∫ïÈÉ®ÊåâÈíÆÂ±Ö‰∏≠Ê†∑Âºè */
        .btn-group-center {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex: 1;
        }

        .modal-footer-btn {
            padding: 12px 30px;
            font-size: 16px;
            min-width: 200px;
        }

        .footer-spacer {
            flex: 1;
        }

        /* Êñá‰ª∂ÈòüÂàóÊ†∑Âºè */
        .file-queue {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .queue-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .queue-item.dragging {
            opacity: 0.8;
            border-color: #3498db;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.2);
            z-index: 5;
        }

        .queue-item.drag-over {
            border: 2px dashed #3498db;
            background: #f0f8ff;
            transform: translateY(5px);
        }

        .file-preview {
            flex: 0 0 150px;
            position: relative;
        }

        .file-preview img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: rgba(41, 128, 185, 1);
        }

        .file-config {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .config-item label {
            font-size: 0.85em;
            font-weight: 600;
            color: #495057;
        }

        .copies-input {
            width: 70px;
            padding: 6px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(23px);
        }

        .filaments-container {
            flex: 0 0 550px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 1px solid #e9ecef;
        }

        .filaments-title {
            font-size: 0.85em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .filaments-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filament-box {
            width: 70px;
            height: 25px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65em;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
            text-shadow: 0 1px 1px rgba(0,0,0,0.3);
        }

        .filament-box-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .slot-info {
            font-size: 0.55em;
            color: #495057;
            font-weight: 600;
            text-align: center;
            min-height: 12px;
            line-height: 1;
        }

        .filament-box.unassigned {
            background: repeating-linear-gradient(
                45deg,
                #f8f9fa,
                #f8f9fa 5px,
                #e9ecef 5px,
                #e9ecef 10px
            );
            color: #6c757d;
            text-shadow: none;
        }

        .filament-box.assigned {
            background: linear-gradient(to bottom, var(--required-color) 50%, var(--selected-color) 50%);
            color: white;
        }

        /* ÁßªÈô§ÊåâÈíÆÊ†∑Âºè */
        .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            z-index: 5;
        }

        .remove-btn:hover {
            background: rgba(192, 57, 43, 1);
        }

        /* ËÄóÊùêÈÄâÊã©ÂºπÁ™ó */
        .filament-section {
            margin-bottom: 15px;
        }

        .filament-section-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        .ams-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .ams-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            padding: 6px;
            box-sizing: border-box;
            position: relative;
        }

        .ams-slot:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .ams-slot.disabled,
        .external-spool.disabled {
            color: #000000 !important;
            background: repeating-linear-gradient(
                45deg,
                #f8f9fa,
                #f8f9fa 5px,
                #e9ecef 5px,
                #e9ecef 10px
            ) !important;
        }

        .ams-slot.disabled .ams-slot-number,
        .ams-slot.disabled .ams-slot-type,
        .external-spool.disabled .ams-slot-type {
            color: #000000 !important;
        }

        .ams-slot.disabled:hover {
            border-color: #e9ecef;
            transform: none;
            box-shadow: none;
        }

        .ams-slot-number {
            font-size: 0.65em;
            color: #6c757d;
            margin-bottom: 2px;
        }

        .ams-slot-type {
            font-size: 0.7em;
            margin-top: 2px;
        }

        .external-spool {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            padding: 6px;
            box-sizing: border-box;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .external-spool:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .external-spool.disabled:hover {
            border-color: #e9ecef;
            transform: none;
            box-shadow: none;
        }

        /* Êô∫ËÉΩÊñáÂ≠óÈ¢úËâ≤ - Ê†πÊçÆËÉåÊôØËâ≤Ëá™Âä®Ë∞ÉÊï¥ */
        .text-auto {
            /* ÈªòËÆ§ÊñáÂ≠óÈ¢úËâ≤ÔºåJSÂä®ÊÄÅË¶ÜÁõñ */
        }

        .filament-modal {
            display: none;
            position: absolute;
            top: -200px;
            left: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1001;
            min-width: 300px;
        }

        .filament-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filament-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .filament-modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1003;
        }

        .filament-modal-title {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .filament-requirement {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .requirement-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-left: 10px;
            border: 1px solid #ccc;
        }

        .ams-group {
            margin-bottom: 15px;
        }

        .available-filaments {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .available-filament {
            width: 100%;
            height: 80px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
        }

        .available-filament:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .available-filament.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: repeating-linear-gradient(
                45deg,
                #f8f9fa,
                #f8f9fa 5px,
                #e9ecef 5px,
                #e9ecef 10px
            ) !important;
        }

        .available-filament.disabled:hover {
            border-color: #e9ecef;
            transform: none;
            box-shadow: none;
        }

        /* Â∫ïÈÉ®ÊåâÈíÆÂå∫Âüü */
        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-top: 2px solid #e9ecef;
            position: sticky;
            bottom: -20px;
            background: white;
            z-index: 10;
            margin: 0 -20px -20px -20px;
            box-shadow: none;
        }

        .progress-info {
            font-size: 0.9em;
            color: #6c757d;
            flex: 1;
            margin-right: 20px;
        }

        /* ÊãñÊãΩÊªöÂä®Âå∫Âüü */
        .drag-scroll-area {
            position: fixed;
            z-index: 100;
            background: rgba(52, 152, 219, 0.1);
            border: 2px dashed #3498db;
            display: none;
        }

        .drag-scroll-area.top {
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
        }

        .drag-scroll-area.bottom {
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
        }

        /* ÊúçÂä°Âô®Êñá‰ª∂ÂØºËà™Ê†∑Âºè */
        .server-nav {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 0 10px;
            background: transparent;
            border: none;
            padding: 0;
            flex: 1;
            height: 28px;
        }

        .path-input-group {
            display: flex;
            align-items: center;
            max-width:  280px;
            height: 100%;
        }

        .path-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #e9ecef;
            border-radius: 3px 0 0 3px;
            font-size: 0.8em;
            border-right: none;
            background: white;
            min-width: 120px;
            height: 100%;
            box-sizing: border-box;
            line-height: 1;
        }

        .path-btn {
            padding: 4px 10px;
            background: #6c757d;
            color: white;
            border: 1px solid #6c757d;
            border-radius: 0 3px 3px 0;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.8em;
            white-space: nowrap;
            height: 100%;
            box-sizing: border-box;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .path-btn:hover {
            background: #5a6268;
        }

        .back-btn {
            padding: 4px 10px;
            background: #495057;
            color: white;
            border: 1px solid #495057;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.8em;
            white-space: nowrap;
            height: 100%;
            box-sizing: border-box;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-btn:hover {
            background: #343a40;
        }

        .back-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 6px;
            height: 100%;
        }

        .filter-label {
            font-size: 0.8em;
            color: #495057;
            white-space: nowrap;
        }

        .filter-group input[type="checkbox"] {
            margin: 0;
            vertical-align: middle;
            transform: scale(0.85);
        }

        /* ÊúçÂä°Âô®Êñá‰ª∂Êìç‰ΩúÊ†è */
        .server-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            min-height: 24px;
        }

        .server-checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .server-checkbox-group label {
            font-size: 0.8em;
        }

        .server-batch-actions {
            display: flex;
            gap: 6px;
        }

        .server-batch-actions .btn-small {
            padding: 3px 6px;
            font-size: 10px;
        }

        /* Êñá‰ª∂Á±ªÂûãÂõæÊ†á */
        .file-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .file-type-directory {
            color: #3498db;
        }

        .file-type-file {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Flask Ê≥®ÂÖ•ÁöÑÊï∞ÊçÆÔºàÈöêËóèÔºâÔºåÈÅøÂÖçÂú®ËÑöÊú¨‰∏≠Áõ¥Êé•‰ΩøÁî® Jinja Ë°®ËææÂºèÂØºËá¥ÁºñËæëÂô®ËØ≠Ê≥ïÊä•Èîô -->
    <div id="flask-data" style="display:none" data-current-dir="{{ current_dir|e }}"></div>
    <div class="container">
        <div class="header">
            <h1>ÊãìÁ´πËøûÁª≠ÊâìÂç∞ÈòüÂàóÁîüÊàê</h1>
            <p>‰∏ä‰º†Êñá‰ª∂Âà∞ÊâìÂç∞Êú∫ÂíåÁîüÊàêËøûÁª≠ÊâìÂç∞Ëá™Âä®ÂåñÈÖçÁΩÆ</p>
        </div>
        
        <div class="content">
            <!-- Êú¨Âú∞Êñá‰ª∂Êìç‰ΩúÂå∫Âüü -->
            <div class="section">
                <div class="section-title">
                    <span>ËØ∑ÈÄâÊã©3mfÊñá‰ª∂<span id="localFileCount" class="file-count">(0)</span></span>
                    <div style="flex: 1;"></div>
                    <button class="btn btn-primary" onclick="triggerLocalUpload()">
                        üì• Êñ∞Â¢û3mfÊñá‰ª∂
                    </button>
                </div>
                
                <div class="server-actions">
                    <div class="server-checkbox-group">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label for="selectAll">ÂÖ®ÈÄâ</label>
                        <span class="filename-hint">Âè™ËÉΩÂ§ÑÁêÜÂàáÁâáÂêéÁöÑ3mfÊñá‰ª∂‰∏îÊñá‰ª∂ÂêçÊúÄÂ§ßÂè™ËÉΩ47‰∏™ÊñáÂ≠óÔºàÂåÖÊã¨ÂêéÁºÄÔºâ</span>
                    </div>
                    <div class="server-batch-actions">
                        <button class="btn btn-danger btn-small" onclick="batchDeleteLocalFiles()">ÊâπÈáèÂà†Èô§</button>
                    </div>
                </div>
                
                <div class="file-list" id="fileList">
                    <!-- Âä®ÊÄÅÂä†ËΩΩÂÜÖÂÆπ -->
                </div>
                
                <div class="message" id="uploadMessage"></div>
                <div id="uploadResults"></div>
            </div>
            
            <!-- ÊúçÂä°Âô®Êñá‰ª∂Âå∫Âüü -->
            <div class="section">
                <div class="section-title">
                    <span>ÊâìÂç∞Êú∫Êñá‰ª∂<span id="serverFileCount" class="file-count">(0)</span></span>
                    <div class="server-nav">
                        <div class="path-input-group">
                            <input type="text" class="path-input" id="currentPath" placeholder="/">
                            <button class="path-btn" onclick="goToPath()">Ë∑≥ËΩ¨</button>
                            <button class="back-btn" id="backBtn" onclick="goBack()" disabled>‚Üë</button>
                        </div>
                        <div class="filter-group">
                            <input type="checkbox" id="filter3mf" onchange="toggle3mfFilter()">
                            <label for="filter3mf" class="filter-label">‰ªÖ3MF</label>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="refreshServerFiles()">
                        üîÑ Âà∑Êñ∞
                    </button>
                </div>

                <!-- ÊúçÂä°Âô®Êñá‰ª∂Êìç‰ΩúÊ†è -->
                <div class="server-actions">
                    <div class="server-checkbox-group">
                        <input type="checkbox" id="selectAllServer" onchange="toggleSelectAllServer()">
                        <label for="selectAllServer">ÂÖ®ÈÄâ</label>
                        <span class="filename-hint">Âè™ËÉΩÂ§ÑÁêÜ3mfÊñá‰ª∂ÔºåÂ§ÑÁêÜËøáÁ®ã‰ºöËá™Âä®‰∏ãËΩΩÔºåÂ§ßÊñá‰ª∂ÈùûÂ∏∏ËÄóÊó∂</span>
                    </div>
                    <div class="server-batch-actions">
                        <button class="btn btn-primary btn-small" onclick="batchDownloadServerFiles()">ÊâπÈáè‰∏ãËΩΩ</button>
                        <button class="btn btn-danger btn-small" onclick="batchDeleteServerFiles()">ÊâπÈáèÂà†Èô§</button>
                    </div>
                </div>
                
                <div class="file-list server-file-list" id="serverFileList">
                    <!-- Âä®ÊÄÅÂä†ËΩΩÂÜÖÂÆπ -->
                </div>
                
                <div class="message" id="serverMessage"></div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆÂå∫Âüü -->
        <div class="footer">
            <button class="btn btn-primary footer-btn" onclick="openConfigModal()">
                ‚öôÔ∏è ÈÖçÁΩÆ
            </button>
            <div class="footer-center">
                <button class="btn btn-success footer-btn footer-btn-wide" onclick="openPrintQueueModal()">
                    üìù ‰∏ã‰∏ÄÊ≠•<span id="selectedFileCount" class="selected-count">(0)</span>
                </button>
            </div>
            <div class="footer-right">
                <button class="btn btn-primary footer-btn" onclick="triggerFileUpload()">
                    üì§ ‰∏ä‰º†Âà∞ÊâìÂç∞Êú∫
                </button>
            </div>
        </div>
    </div>

    <!-- Âçï‰∏™Êñá‰ª∂‰∏ãËΩΩËøõÂ∫¶ÂºπÁ™ó -->
    <div class="download-modal" id="downloadModal">
        <div class="download-modal-content">
            <div class="download-modal-title">
                <span>üì•</span>
                <span>Ê≠£Âú®‰∏ãËΩΩÊñá‰ª∂</span>
            </div>
            <div class="download-modal-message" id="downloadModalMessage">
                <!-- ‰∏ãËΩΩÊ∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <div class="download-progress-container">
                <div class="download-progress-bar">
                    <div class="download-progress-fill" id="downloadProgressFill" style="width: 0%">0%</div>
                </div>
                <div class="download-progress-details" id="downloadProgressDetails">
                    <!-- ËøõÂ∫¶ËØ¶ÊÉÖÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
                <div class="download-progress-stats">
                    <span id="downloadCurrentFile">ÂΩìÂâçÊñá‰ª∂: -</span>
                    <span id="downloadSpeed">ÈÄüÂ∫¶: -</span>
                </div>
            </div>
            <div class="loading" style="margin: 20px 0;">
                <div class="spinner"></div>
                <div>‰∏ãËΩΩ‰∏≠...</div>
            </div>
            <div class="btn-group" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-danger" onclick="cancelDownload()" id="cancelDownloadBtn">
                    ‚ùå ÂèñÊ∂à‰∏ãËΩΩ
                </button>
            </div>
        </div>
    </div>

    <!-- ÊâπÈáè‰∏ãËΩΩËøõÂ∫¶ÂºπÁ™ó -->
    <div class="download-modal" id="batchDownloadModal">
        <div class="batch-download-modal-content">
            <div class="download-modal-title">
                <span>üì•</span>
                <span>ÊâπÈáè‰∏ãËΩΩÊñá‰ª∂</span>
            </div>
            <div class="batch-download-summary" id="batchDownloadSummary">
                <!-- ÊâπÈáè‰∏ãËΩΩÊëòË¶ÅÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <div class="batch-download-overall-progress">
                <div class="download-modal-message" id="batchDownloadMessage">
                    Ê≠£Âú®ÂáÜÂ§á‰∏ãËΩΩ...
                </div>
                <div class="download-progress-bar">
                    <div class="download-progress-fill" id="batchDownloadProgressFill" style="width: 0%">0%</div>
                </div>
                <div class="download-progress-details" id="batchDownloadProgressDetails">
                    ÊÄª‰ΩìËøõÂ∫¶: 0%
                </div>
            </div>
            <div class="batch-download-file-progress">
                <div class="download-progress-details" id="batchDownloadFileProgress">
                    ÂΩìÂâçÊñá‰ª∂: -
                </div>
                <div class="download-progress-bar" style="height: 15px;">
                    <div class="download-progress-fill" id="batchDownloadFileProgressFill" style="width: 0%">0%</div>
                </div>
            </div>
            <div class="batch-download-file-list" id="batchDownloadFileList">
                <!-- Êñá‰ª∂ÂàóË°®Â∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <div class="loading" style="margin: 20px 0;">
                <div class="spinner"></div>
                <div>ÊâπÈáè‰∏ãËΩΩ‰∏≠...</div>
            </div>
            <div class="btn-group" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-danger" onclick="cancelBatchDownload()" id="cancelBatchDownloadBtn">
                    ‚ùå ÂèñÊ∂à‰∏ãËΩΩ
                </button>
            </div>
        </div>
    </div>

    <!-- ‰∏ä‰º†ËøõÂ∫¶ÂºπÁ™ó -->
    <div class="error-modal" id="uploadProgressModal">
        <div class="error-modal-content">
            <div class="error-modal-title">
                <span>üì§</span>
                <span>Êñá‰ª∂‰∏ä‰º†ËøõÂ∫¶</span>
            </div>
            <div class="error-modal-message" id="uploadProgressMessage">
                <!-- ‰∏ä‰º†ËøõÂ∫¶Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <div class="progress-bar" style="margin: 15px 0;">
                <div class="progress-bar-fill" id="uploadProgressFill" style="width: 0%">0%</div>
            </div>
            <div class="progress-details" id="uploadProgressDetails">
                <!-- ‰∏ä‰º†ËøõÂ∫¶ËØ¶ÊÉÖÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <div class="loading" style="margin: 20px 0;">
                <div class="spinner"></div>
                <div>‰∏ä‰º†‰∏≠...</div>
            </div>
        </div>
    </div>

    <!-- ÈÖçÁΩÆÂºπÁ™ó -->
    <div class="config-modal" id="configModal">
        <div class="config-modal-content">
            <div class="config-modal-header">
                <h2 class="config-modal-title">Á≥ªÁªüÈÖçÁΩÆ</h2>
                <span class="close" onclick="closeConfigModal()">&times;</span>
            </div>

            <div class="config-modal-body">
                <!-- Â∑¶‰æßÔºöÊâìÂç∞Êú∫ÈÖçÁΩÆ -->
                <div class="config-column">
                    <h3 class="config-section-title">ÊâìÂç∞Êú∫ÈÖçÁΩÆ</h3>
                    
                    <div class="form-group">
                        <label for="host">ÊâìÂç∞Êú∫IPÂú∞ÂùÄ:</label>
                        <input type="text" id="host" name="host" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="port">
                            ÊâìÂç∞Êú∫Á´ØÂè£:
                            <span style="color: #6c757d; font-size: 0.8em; margin-left: 8px; font-weight: normal;">
                                ÈªòËÆ§Á´ØÂè£990
                            </span>
                        </label>
                        <input type="number" id="port" name="port" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="user">
                            ÊâìÂç∞Êú∫Áî®Êà∑Âêç:
                            <span style="color: #6c757d; font-size: 0.8em; margin-left: 8px; font-weight: normal;">
                                ÈªòËÆ§Áî®Êà∑bblp
                            </span>
                        </label>
                        <input type="text" id="user" name="user" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">
                            Â±ÄÂüüÁΩëËÆøÈóÆÁ†Å: 
                            <span style="color: #6c757d; font-size: 0.8em; margin-left: 8px; font-weight: normal;">
                                ÊâìÂç∞Êú∫ËÆæÁΩÆ-Â±ÄÂüüÁΩëÊ®°ÂºèËÆøÈóÆÁ†Å
                            </span>
                        </label>
                        <input type="text" id="password" name="password" required>
                    </div>

                </div>

                <!-- Âè≥‰æßÔºöHome AssistantÈÖçÁΩÆ -->
                <div class="config-column">
                    <h3 class="config-section-title">Home AssistantÈÖçÁΩÆ</h3>

                    <div class="form-group">
                        <label for="ha_url">
                            Home AssistantÂú∞ÂùÄ:
                            <span style="color: #6c757d; font-size: 0.8em; margin-left: 8px; font-weight: normal;">
                                ÈúÄË¶ÅÂ∏¶ÂâçÁºÄhttp://Êàñhttps://
                            </span>
                        </label>
                        <input type="url" id="ha_url" name="ha_url" placeholder="http://homeassistant.local:8123">
                    </div>

                    <div class="form-group">
                        <label for="ha_token">
                            Home Assistant API‰ª§Áâå:
                            <span style="color: #6c757d; font-size: 0.8em; margin-left: 8px; font-weight: normal;">
                                HAÂ∑¶‰æßÂ∫ïÈÉ®Ë¥¶Êà∑-ÂÆâÂÖ®-ÂàõÂª∫ÈïøÊúüËÆøÈóÆ‰ª§Áâå
                            </span>
                        </label>
                        <input type="password" autocomplete="new-password" id="ha_token" name="ha_token">
                    </div>

                    <div class="form-group">
                        <label for="printer_entity">
                            HA‰∏≠ÊâìÂç∞Êú∫ÂÆû‰ΩìÊ†áËØÜ:
                            <span style="color: #6c757d; font-size: 0.8em; margin-left: 8px; font-weight: normal;">
                                ÊâìÂç∞Êú∫‰ªªÊÑèÂÆû‰ΩìÁöÑÊ†áËØÜÁ¨¶ÂâçÁºÄ
                            </span>
                        </label>
                        <input type="text" id="printer_entity" name="printer_entity" placeholder="a1mini_xxxxxxxxxxxxxxx">
                    </div>

                    <div class="form-group">
                        <label for="path">
                            ÁΩëÈ°µÂêØÂä®Êó∂ÊâìÂç∞Êú∫ÈªòËÆ§Ë∑ØÂæÑ:
                            <span style="color: #6c757d; font-size: 0.8em; margin-left: 8px; font-weight: normal;">
                                Êñπ‰æøÁõ¥Êé•Êìç‰ΩúÔºå‰æãÂ¶Ça1miniÂ≠òÊîæÊâìÂç∞Êñá‰ª∂ÁöÑË∑ØÂæÑ‰∏∫/cache
                            </span>
                        </label>
                        <input type="text" id="path" name="path" required>
                    </div>

                </div>
            </div>

            <div class="config-modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveConfig()">
                    üíæ ‰øùÂ≠òÈÖçÁΩÆ
                </button>
                <button type="button" class="btn btn-success" onclick="testConnection()">
                    üöÄ ÊµãËØïFTPËøûÊé•
                </button>
                <button type="button" class="btn btn-warning" onclick="testHAConnection()">
                    üè† ÊµãËØïHAËøûÊé•
                </button>
            </div>
        </div>
    </div>

    <!-- ÊâìÂç∞ÈòüÂàóÈÖçÁΩÆÂºπÁ™ó -->
    <div class="modal" id="printQueueModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÊâìÂç∞ÈòüÂàóÈÖçÁΩÆ</h2>
                <div class="quick-config-header">
                    <div class="quick-config-title">‰∏ÄÈîÆÈÖçÁΩÆ</div>
                    <div class="quick-config-item">
                        <label>Âª∂Êó∂ÊëÑÂΩ±</label>
                        <label class="switch-header">
                            <input type="checkbox" id="quickTimelapse" onchange="applyQuickConfig('timelapse', this.checked)">
                            <span class="slider-header"></span>
                        </label>
                    </div>
                    <div class="quick-config-item">
                        <label>ÁÉ≠Â∫äË∞ÉÂπ≥</label>
                        <label class="switch-header">
                            <input type="checkbox" id="quickBedLeveling" checked onchange="applyQuickConfig('bed_leveling', this.checked)">
                            <span class="slider-header"></span>
                        </label>
                    </div>
                    <div class="quick-config-item">
                        <label>ÊµÅÈáèÊ†°ÂáÜ</label>
                        <label class="switch-header">
                            <input type="checkbox" id="quickFlowCali" checked onchange="applyQuickConfig('flow_cali', this.checked)">
                            <span class="slider-header"></span>
                        </label>
                    </div>
                </div>
                <span class="close" onclick="closePrintQueueModal()">&times;</span>
            </div>

            <!-- Êñá‰ª∂ÈòüÂàó -->
            <div class="file-queue" id="fileQueue">
                <!-- Âä®ÊÄÅÁîüÊàêÊñá‰ª∂ÈòüÂàóÈ°π -->
            </div>

            <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
            <div class="modal-footer">
                <div class="progress-info" id="progressInfo">
                    <!-- ËøõÂ∫¶‰ø°ÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
                <div class="btn-group-center">
                    <button class="btn btn-primary modal-footer-btn" onclick="createAutomation()">‰∏ä‰º†Âà∞ÊâìÂç∞Êú∫<br>Âπ∂ÂàõÂª∫Ëá™Âä®Âåñ</button>
                    <button class="btn btn-success modal-footer-btn" id="startPrintBtn" onclick="startPrint()">ÂºÄÂßãÊâìÂç∞</button>
                </div>
                <div class="footer-spacer"></div>
            </div>
        </div>
    </div>

    <!-- ÈîôËØØÂºπÁ™ó -->
    <div class="error-modal" id="errorModal">
        <div class="error-modal-content">
            <div class="error-modal-title">
                <span>‚ùå</span>
                <span>ÈîôËØØ</span>
            </div>
            <div class="error-modal-message" id="errorModalMessage">
                <!-- ÈîôËØØÊ∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <div class="error-modal-buttons">
                <button class="btn-copy-yaml" onclick="copyAutomationYaml()" id="errorCopyYamlBtn" style="display: none;">
                    üìã Â§çÂà∂Ëá™Âä®Âåñyaml
                </button>
                <button class="error-modal-button" onclick="closeErrorModal()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <!-- Â§ÑÁêÜ‰∏≠ÂºπÁ™ó -->
    <div class="error-modal" id="processingModal">
        <div class="error-modal-content">
            <div class="error-modal-title">
                <span>‚è≥</span>
                <span>Ê≠£Âú®Â§ÑÁêÜ</span>
            </div>
            <div class="error-modal-message" id="processingModalMessage">
                <!-- Â§ÑÁêÜÊ∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <div class="loading" style="margin: 20px 0;">
                <div class="spinner"></div>
                <div>ËØ∑Á®çÂÄô...</div>
            </div>
        </div>
    </div>

    <!-- ÊàêÂäüÂºπÁ™ó -->
    <div class="success-modal" id="successModal">
        <div class="success-modal-content">
            <div class="success-modal-title">
                <span>‚úÖ</span>
                <span>ÊàêÂäü</span>
            </div>
            <div class="success-modal-message" id="successModalMessage">
                <!-- ÊàêÂäüÊ∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
            <div class="success-modal-buttons">
                <button class="btn-copy-yaml" onclick="copyAutomationYaml()" id="copyYamlBtn" style="display: none;">
                    üìã Â§çÂà∂Ëá™Âä®Âåñyaml
                </button>
                <button class="success-modal-button" onclick="closeSuccessModal()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <!-- ÊãñÊãΩÊªöÂä®Âå∫Âüü -->
    <div class="drag-scroll-area top" id="dragScrollTop"></div>
    <div class="drag-scroll-area bottom" id="dragScrollBottom"></div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let selectedFiles = [];
        let printQueue = [];
        let filamentMapping = {};
        let currentWebhookId = null;
        let dragSrcElement = null;
        let dragOverElement = null;
        let dragScrollInterval = null;
        let isDragging = false;
        let dragStartIndex = null;
        let currentAutomationYaml = null;
        let progressPollingInterval = null;
        let lastProgressUpdate = 0;
        let currentServerPath = '/';
        let filter3mfOnly = false;
        let automationCreated = false;
        let allServerFiles = [];
        let config_default_path = null;
        let downloadPollingInterval = null;
        let lastDownloadProgressUpdate = 0;
        let downloadStartTime = null;
        let lastDownloadedBytes = 0;
        let currentBatchDownload = null;
        let batchDownloadPollingInterval = null;
        let isDownloadCancelling = false;
        let batchSavedSet = new Set();
        let fileUploadInput = null;
        let localFileUploadInput = null;
        let currentUploadId = null;
        let uploadPollingInterval = null;
        let isUploadCancelling = false;
        let runtimeBasePath = '';

        // Â∞ÜÂêéÁ´ØËøêË°åÁõÆÂΩï‰∏éÁõ∏ÂØπË∑ØÂæÑÊãºÊé•Ôºå‰æø‰∫éÊñá‰ª∂ËÆøÈóÆ
        function withRuntimePath(path) {
            if (!path) return path;
            if (/^https?:\/\//i.test(path)) return path;
            const base = (runtimeBasePath || '').replace(/\\/g, '/').replace(/\/+$/, '');
            if (!base) return path;
            const cleaned = path.replace(/^[\\/]+/, '');
            const isAbsFs = /^[a-zA-Z]:\//.test(base) || base.startsWith('/');
            // ÁªùÂØπÊñá‰ª∂Ë∑ØÂæÑÊó†Ê≥ïË¢´ÊµèËßàÂô®Áõ¥Êé•Âä†ËΩΩÔºåÂõûÈÄÄÂà∞ÂΩìÂâçÁ´ôÁÇπÁöÑÁªùÂØπË∑ØÂæÑ
            if (isAbsFs) {
                return `${window.location.origin}/${cleaned}`;
            }
            return `${base}/${cleaned}`;
        }

        async function loadRuntimeInfo() {
            try {
                const res = await fetch('./api/runtime-info');
                if (!res.ok) throw new Error(`status ${res.status}`);
                const data = await res.json();
                if (data && data.current_dir) {
                    runtimeBasePath = String(data.current_dir);
                }
                console.log('ËøêË°åÁõÆÂΩï:', runtimeBasePath);
            } catch (err) {
                console.warn('Ëé∑ÂèñËøêË°åÁõÆÂΩïÂ§±Ë¥•:', err);
                runtimeBasePath = '';
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async function() {
            await loadRuntimeInfo();
            await loadConfig();

            initFileUpload();
            initLocalUpload();
            loadFiles();
            setupPathInputEvents();
            loadServerFiles(config_default_path);
        });
        
        // ÂàùÂßãÂåñÊâìÂç∞Êú∫‰∏ä‰º†ËæìÂÖ•Ê°Ü
        function initFileUpload() {
            fileUploadInput = document.createElement('input');
            fileUploadInput.type = 'file';
            fileUploadInput.id = 'fileUploadInput';
            fileUploadInput.multiple = true;
            fileUploadInput.style.display = 'none';
            fileUploadInput.addEventListener('change', handleFileUpload);
            document.body.appendChild(fileUploadInput);
        }

        // ÂàùÂßãÂåñÊú¨Âú∞3mf‰∏ä‰º†ËæìÂÖ•Ê°Ü
        function initLocalUpload() {
            localFileUploadInput = document.createElement('input');
            localFileUploadInput.type = 'file';
            localFileUploadInput.id = 'localFileUploadInput';
            localFileUploadInput.multiple = true;
            localFileUploadInput.accept = '.3mf';
            localFileUploadInput.style.display = 'none';
            localFileUploadInput.addEventListener('change', handleLocal3mfUpload);
            document.body.appendChild(localFileUploadInput);
        }

        // Ëß¶ÂèëÊâìÂç∞Êú∫‰∏ä‰º†Êñá‰ª∂ÈÄâÊã©Ôºà‰øùÁïôÂéüÈÄªËæëÔºâ
        function triggerFileUpload() {
            if (!fileUploadInput) {
                initFileUpload();
            }
            fileUploadInput.click();
        }

        // Ëß¶ÂèëÊú¨Âú∞3mf‰∏ä‰º†Êñá‰ª∂ÈÄâÊã©
        function triggerLocalUpload() {
            if (!localFileUploadInput) {
                initLocalUpload();
            }
            localFileUploadInput.click();
        }

        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) {
                return;
            }

            // Ê£ÄÊü•Êñá‰ª∂ÂêçÈïøÂ∫¶
            const invalidFiles = [];
            for (let i = 0; i < files.length; i++) {
                if (files[i].name.length > 47) {
                    invalidFiles.push(files[i].name);
                }
            }

            if (invalidFiles.length > 0) {
                let errorMessage = `‰ª•‰∏ãÊñá‰ª∂ÂêçË∂ÖËøá47‰∏™Â≠óÁ¨¶ÈôêÂà∂:<br><br>`;
                invalidFiles.slice(0, 3).forEach(filename => {
                    errorMessage += `${filename}<br>`;
                });
                if (invalidFiles.length > 3) {
                    errorMessage += `... ‰ª•ÂèäÂè¶Â§ñ ${invalidFiles.length - 3} ‰∏™Êñá‰ª∂`;
                }
                errorMessage += `<br><br>Áî±‰∫éÊâìÂç∞Êú∫FTPÈôêÂà∂ÔºåÊñá‰ª∂ÂêçÊúÄÂ§ßÂè™ËÉΩ47‰∏™ÊñáÂ≠óÔºàÂåÖÊã¨ÂêéÁºÄÔºâÔºåËØ∑ÈáçÂëΩÂêçÂêéÂÜç‰∏ä‰º†`;
                showErrorModal(errorMessage);
                event.target.value = '';
                return;
            }

            // ÁîüÊàê‰∏ä‰º†ID
            currentUploadId = 'upload_' + Date.now();
            isUploadCancelling = false;
            
            // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶ÂºπÁ™ó
            showUploadProgressModal(files.length);

            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }
                // Ê∑ªÂä†ÁõÆÊ†áË∑ØÂæÑ
                formData.append('path', currentServerPath);
                // Ê∑ªÂä†‰∏ä‰º†IDÁî®‰∫éË∑üË∏™
                formData.append('upload_id', currentUploadId);

                // ÂºÄÂßãËΩÆËØ¢‰∏ä‰º†ËøõÂ∫¶
                startUploadProgressPolling();

                const response = await fetch('./api/upload-any', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // ÂÅúÊ≠¢ËΩÆËØ¢
                stopUploadProgressPolling();

                if (data.success) {
                    closeUploadProgressModal();
                    showSuccessModal(`ÊàêÂäü‰∏ä‰º† ${files.length} ‰∏™Êñá‰ª∂Âà∞ÊâìÂç∞Êú∫ÔºÅ`);
                    // ‰∏ä‰º†ÊàêÂäüÂêéÂà∑Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÂàóË°®
                    setTimeout(() => {
                        loadServerFiles(currentServerPath);
                    }, 1000);
                } else {
                    closeUploadProgressModal();
                    showErrorModal('‰∏ä‰º†Â§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                stopUploadProgressPolling();
                closeUploadProgressModal();
                showErrorModal('‰∏ä‰º†Â§±Ë¥•: ' + error);
            } finally {
                // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•Ê°Ü
                event.target.value = '';
            }
        }

        // Â§ÑÁêÜÊú¨Âú∞3mf‰∏ä‰º†Ôºà‰øùÂ≠òÂà∞Á®ãÂ∫èÁõÆÂΩï 3mf Êñá‰ª∂Â§πÔºâ
        async function handleLocal3mfUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) {
                return;
            }

            // Êñá‰ª∂ÂêçÈïøÂ∫¶Ê†°È™å
            const invalidFiles = [];
            for (let i = 0; i < files.length; i++) {
                if (files[i].name.length > 47) {
                    invalidFiles.push(files[i].name);
                }
            }
            if (invalidFiles.length > 0) {
                let errorMessage = `‰ª•‰∏ãÊñá‰ª∂ÂêçË∂ÖËøá47‰∏™Â≠óÁ¨¶ÈôêÂà∂:<br><br>`;
                invalidFiles.slice(0, 3).forEach(filename => {
                    errorMessage += `${filename}<br>`;
                });
                if (invalidFiles.length > 3) {
                    errorMessage += `... ‰ª•ÂèäÂè¶Â§ñ ${invalidFiles.length - 3} ‰∏™Êñá‰ª∂`;
                }
                errorMessage += `<br><br>Áî±‰∫éÊâìÂç∞Êú∫FTPÈôêÂà∂ÔºåÊñá‰ª∂ÂêçÊúÄÂ§ßÂè™ËÉΩ47‰∏™ÊñáÂ≠óÔºàÂåÖÊã¨ÂêéÁºÄÔºâÔºåËØ∑ÈáçÂëΩÂêçÂêéÂÜç‰∏ä‰º†`;
                showErrorModal(errorMessage);
                event.target.value = '';
                return;
            }

            // ‰ªÖÊé•Âèó3mfÊâ©Â±ï
            const non3mf = [];
            for (let i = 0; i < files.length; i++) {
                if (!files[i].name.toLowerCase().endsWith('.3mf')) {
                    non3mf.push(files[i].name);
                }
            }
            if (non3mf.length > 0) {
                showErrorModal(`‰ªÖÊîØÊåÅ‰∏ä‰º†3mfÊñá‰ª∂ÔºåËØ∑Ê£ÄÊü•: ${non3mf.join(', ')}`);
                event.target.value = '';
                return;
            }

            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }

                const response = await fetch('./api/upload-local-3mf', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const savedCount = data.saved ? data.saved.length : files.length;
                    await loadFiles();
                } else {
                    showErrorModal('‰∏ä‰º†Â§±Ë¥•: ' + (data.error || response.statusText));
                }
            } catch (error) {
                showErrorModal('‰∏ä‰º†Â§±Ë¥•: ' + error);
            } finally {
                event.target.value = '';
            }
        }

        // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶ÂºπÁ™ó
        function showUploadProgressModal(totalFiles) {
            const uploadModal = document.getElementById('uploadProgressModal');
            const uploadMessage = document.getElementById('uploadProgressMessage');
            
            uploadMessage.innerHTML = `ÂáÜÂ§á‰∏ä‰º† ${totalFiles} ‰∏™Êñá‰ª∂Âà∞ÊâìÂç∞Êú∫...`;
            updateUploadProgressUI(0, 0, 0, '', totalFiles);
            
            uploadModal.style.display = 'flex';
        }

        // ÂÖ≥Èó≠‰∏ä‰º†ËøõÂ∫¶ÂºπÁ™ó
        function closeUploadProgressModal() {
            const uploadModal = document.getElementById('uploadProgressModal');
            uploadModal.style.display = 'none';
            stopUploadProgressPolling();
        }

        // ÂºÄÂßãËΩÆËØ¢‰∏ä‰º†ËøõÂ∫¶
        function startUploadProgressPolling() {
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑËΩÆËØ¢
            if (uploadPollingInterval) {
                clearInterval(uploadPollingInterval);
            }
            
            // ÊØè500ÊØ´ÁßíËé∑Âèñ‰∏ÄÊ¨°ËøõÂ∫¶
            uploadPollingInterval = setInterval(fetchAnyUploadProgress, 500);
        }

        // ÂÅúÊ≠¢ËΩÆËØ¢‰∏ä‰º†ËøõÂ∫¶
        function stopUploadProgressPolling() {
            if (uploadPollingInterval) {
                clearInterval(uploadPollingInterval);
                uploadPollingInterval = null;
            }
        }

        // Ëé∑Âèñ‰∏ä‰º†ËøõÂ∫¶-‰ªªÊÑèÊñá‰ª∂
        async function fetchAnyUploadProgress() {
            try {
                let url = './api/upload-progress';
                if (currentUploadId) {
                    url += `?upload_id=${currentUploadId}`;
                }
                const response = await fetch(url);
                const progress = await response.json();
                
                // Êõ¥Êñ∞UI
                updateUploadProgressFromAPI(progress);
                
                // Â§ÑÁêÜ‰∏çÂêåÁöÑÁä∂ÊÄÅ
                if (progress.status === 'cancelled') {
                    // ‰∏ä‰º†Ë¢´ÂèñÊ∂à
                    stopUploadProgressPolling();
                    setTimeout(() => {
                        closeUploadProgressModal();
                    }, 500);
                    
                } else if (progress.status === 'success' || progress.status === 'error' || progress.status === 'completed') {
                    // ‰∏ä‰º†ÂÆåÊàêÊàñÂá∫Èîô
                    stopUploadProgressPolling();
                    
                    // Âª∂ËøüÂêéÂÖ≥Èó≠ÂºπÁ™óÂπ∂ÊòæÁ§∫ÁªìÊûú
                    setTimeout(() => {
                        if (progress.status === 'success') {
                            closeUploadProgressModal();
                        } else if (progress.status === 'error') {
                            closeUploadProgressModal();
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Ëé∑Âèñ‰∏ä‰º†ËøõÂ∫¶Â§±Ë¥•:', error);
            }
        }

        // Ê†πÊçÆAPIËøõÂ∫¶Êï∞ÊçÆÊõ¥Êñ∞UI
        function updateUploadProgressFromAPI(progress) {
            if (progress.current_file && progress.total_files > 0) {
                updateUploadProgressUI(
                    progress.progress,
                    progress.current_file_index + 1,
                    progress.total_files,
                    progress.current_file,
                    progress.total_files,
                    progress.message
                );
            }
        }

        // Êõ¥Êñ∞‰∏ä‰º†ËøõÂ∫¶UI
        function updateUploadProgressUI(progress, currentIndex, totalFiles, currentFile, totalFilesCount, message = '') {
            const uploadProgressFill = document.getElementById('uploadProgressFill');
            const uploadProgressDetails = document.getElementById('uploadProgressDetails');
            const uploadProgressMessage = document.getElementById('uploadProgressMessage');
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progressPercentage = Math.min(100, Math.max(0, progress));
            uploadProgressFill.style.width = `${progressPercentage}%`;
            uploadProgressFill.textContent = `${progressPercentage.toFixed(1)}%`;
            
            // Êõ¥Êñ∞ËøõÂ∫¶ËØ¶ÊÉÖ
            if (currentFile) {
                uploadProgressDetails.innerHTML = `
                    <span class="progress-file">${currentFile}</span><br>
                    ËøõÂ∫¶: <span class="progress-percentage">${progressPercentage.toFixed(1)}%</span><br>
                    Êñá‰ª∂: ${currentIndex}/${totalFiles}
                `;
            } else {
                uploadProgressDetails.innerHTML = `
                    ÊÄª‰ΩìËøõÂ∫¶: <span class="progress-percentage">${progressPercentage.toFixed(1)}%</span><br>
                    ÊÄªÊñá‰ª∂Êï∞: ${totalFilesCount}
                `;
            }
            
            // Êõ¥Êñ∞Ê∂àÊÅØ
            if (message) {
                uploadProgressMessage.textContent = message;
            }
        }

        // Âä†ËΩΩÈÖçÁΩÆ
        async function loadConfig() {
            try {
                const response = await fetch('./api/config');
                const data = await response.json();
                
                if (data.success) {
                    const ftpConfig = data.ftp_config;
                    const haConfig = data.ha_config;
                    
                    document.getElementById('host').value = ftpConfig.host;
                    document.getElementById('port').value = ftpConfig.port;
                    document.getElementById('user').value = ftpConfig.user;
                    document.getElementById('password').value = ftpConfig.password;
                    document.getElementById('path').value = ftpConfig.path;
                    config_default_path = ftpConfig.path;
                    document.getElementById('ha_url').value = haConfig.url;
                    document.getElementById('ha_token').value = haConfig.token;
                    document.getElementById('printer_entity').value = haConfig.printer_entity;
                }
            } catch (error) {
                showErrorModal('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•: ' + error);
            }
        }
        
        // ‰øùÂ≠òÈÖçÁΩÆ
        async function saveConfig() {
            const formData = {
                host: document.getElementById('host').value,
                port: parseInt(document.getElementById('port').value),
                user: document.getElementById('user').value,
                password: document.getElementById('password').value,
                path: document.getElementById('path').value,
                ha_url: document.getElementById('ha_url').value,
                ha_token: document.getElementById('ha_token').value,
                printer_entity: document.getElementById('printer_entity').value
            };
            
            try {
                const response = await fetch('./api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessModal('ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ');
                    closeConfigModal();
                } else {
                    showErrorModal('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                showErrorModal('‰øùÂ≠òÂ§±Ë¥•: ' + error);
            }
        }
        
        // ÊµãËØïÊâìÂç∞Êú∫ËøûÊé•
        async function testConnection() {
            const formData = {
                host: document.getElementById('host').value,
                port: parseInt(document.getElementById('port').value),
                user: document.getElementById('user').value,
                password: document.getElementById('password').value,
                path: document.getElementById('path').value
            };
            
            showProcessingModal('ÊµãËØïFTPËøûÊé•‰∏≠...');
            
            try {
                const response = await fetch('./api/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeProcessingModal();
                    showSuccessModal(data.message);
                    // ÊµãËØïÊàêÂäüÂêéÂà∑Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÂàóË°®
                    loadServerFiles();
                } else {
                    closeProcessingModal();
                    showErrorModal('ËøûÊé•ÊµãËØïÂ§±Ë¥•: ' + data.message);
                }
            } catch (error) {
                closeProcessingModal();
                showErrorModal('ÊµãËØïÂ§±Ë¥•: ' + error);
            }
        }

        // ÊµãËØïHome AssistantËøûÊé•
        async function testHAConnection() {
            const formData = {
                ha_url: document.getElementById('ha_url').value,
                ha_token: document.getElementById('ha_token').value,
                printer_entity: document.getElementById('printer_entity').value
            };
            
            if (!formData.ha_url || !formData.ha_token || !formData.printer_entity) {
                showErrorModal('ËØ∑ÂÖàÂ°´ÂÜôHome AssistantÈÖçÁΩÆ');
                return;
            }
            
            showProcessingModal('ÊµãËØïHome AssistantËøûÊé•‰∏≠...');
            
            try {
                const response = await fetch('./api/test-ha-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeProcessingModal();
                    showSuccessModal(data.message);
                } else {
                    closeProcessingModal();
                    showErrorModal('Home AssistantËøûÊé•ÊµãËØïÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                closeProcessingModal();
                showErrorModal('ÊµãËØïÂ§±Ë¥•: ' + error);
            }
        }
        
        // Âä†ËΩΩÊú¨Âú∞Êñá‰ª∂ÂàóË°®
        async function loadFiles() {
            const fileList = document.getElementById('fileList');
            
            // ÂàõÂª∫Êñ∞ÁöÑloadingÂÖÉÁ¥†
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.innerHTML = `
                <div class="spinner"></div>
                <div>Âä†ËΩΩ‰∏≠...</div>
            `;
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ÂàóË°®Âπ∂ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
            fileList.innerHTML = '';
            fileList.appendChild(loading);
            loading.style.display = 'block';
            
            try {
                // ÂàáÊç¢Ë∑ØÂæÑÊó∂Ê∏ÖÈô§Â∑≤ÈÄâÊñá‰ª∂
                selectedFiles = [];
                const selectAllCheckbox = document.getElementById('selectAll');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }

                const response = await fetch('./api/files');
                const data = await response.json();
                
                // Ê∏ÖÁ©∫Êñá‰ª∂ÂàóË°®ÔºàÂåÖÊã¨loadingÔºâ
                fileList.innerHTML = '';
                
                if (data.success && data.files.length > 0) {
                    // Êåâ‰øÆÊîπÊó∂Èó¥ÈôçÂ∫èÊéíÂàó
                    const sortedFiles = data.files.sort((a, b) => {
                        return new Date(b.modified) - new Date(a.modified);
                    });
                    
                    sortedFiles.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';

                        const escapedName = file.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                        const safeDataName = file.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                        fileItem.innerHTML = `
                            <input type="checkbox" class="file-checkbox" value="${file.path}" data-name="${safeDataName}">
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-details">
                                    <span>Â§ßÂ∞è: ${file.size_formatted}</span>
                                    <span>Êó∂Èó¥: ${file.modified}</span>
                                </div>
                            </div>
                            <div class="file-actions">
                                <button class="btn btn-danger btn-small" title="Âà†Èô§Êñá‰ª∂" onclick="event.stopPropagation(); deleteLocalFile('${escapedName}')">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `;
                        
                        fileItem.addEventListener('click', function(e) {
                            if (e.target.type === 'checkbox') return;
                            
                            const checkbox = this.querySelector('.file-checkbox');
                            checkbox.checked = !checkbox.checked;
                            updateFileCounts();
                        });

                        const checkbox = fileItem.querySelector('.file-checkbox');
                        checkbox.addEventListener('change', updateFileCounts);
                        
                        fileList.appendChild(fileItem);
                    });
                    
                    // Êõ¥Êñ∞Êú¨Âú∞Êñá‰ª∂Êï∞Èáè
                    document.getElementById('localFileCount').textContent = `(${sortedFiles.length})`;
                } else {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.style.cursor = 'pointer';
                    emptyState.innerHTML = `
                        <div>üìÅ</div>
                        <div>ËØ∑ÈÄâÊã©ÂàáÁâáÂêéÁöÑ3mfÊñá‰ª∂</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">ÁÇπÂáªÊ≠§Â§ÑÊñ∞Â¢ûÊñá‰ª∂</div>
                    `;
                    emptyState.addEventListener('click', triggerLocalUpload);
                    fileList.appendChild(emptyState);
                    document.getElementById('localFileCount').textContent = '(0)';
                }
                
                // Êõ¥Êñ∞ÈÄâ‰∏≠Êñá‰ª∂Êï∞Èáè
                updateFileCounts();
            } catch (error) {
                fileList.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•</div>';
                document.getElementById('localFileCount').textContent = '(0)';
            }
        }
        
        // Âä†ËΩΩÊúçÂä°Âô®Êñá‰ª∂ÂàóË°®
        async function loadServerFiles(path = null) {
            const serverFileList = document.getElementById('serverFileList');
            
            // ÂàõÂª∫Êñ∞ÁöÑloadingÂÖÉÁ¥†ÔºåÈÅøÂÖçÂºïÁî®Â∑≤ÁßªÈô§ÁöÑÂÖÉÁ¥†
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.innerHTML = `
                <div class="spinner"></div>
                <div>Âä†ËΩΩ‰∏≠...</div>
            `;
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ÂàóË°®Âπ∂ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
            serverFileList.innerHTML = '';
            serverFileList.appendChild(loading);
            loading.style.display = 'block';
            
            try {
                const requestData = {};
                if (path) {
                    requestData.path = path;
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöË∑ØÂæÑÔºå‰ΩøÁî®ÂΩìÂâçÊúçÂä°Âô®Ë∑ØÂæÑ
                    requestData.path = currentServerPath;
                }
                
                const response = await fetch('./api/server-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                // Ê∏ÖÁ©∫Êñá‰ª∂ÂàóË°®ÔºàÂåÖÊã¨loadingÔºâ
                serverFileList.innerHTML = '';
                
                if (data.success && data.files.length > 0) {
                    // Êõ¥Êñ∞ÂΩìÂâçË∑ØÂæÑ
                    currentServerPath = data.current_path || '/';
                    document.getElementById('currentPath').value = currentServerPath;
                    
                    // Êõ¥Êñ∞ËøîÂõûÊåâÈíÆÁä∂ÊÄÅ
                    updateBackButton();
                    
                    // ‰øùÂ≠òÊâÄÊúâÊúçÂä°Âô®Êñá‰ª∂Âà∞ÂÖ®Â±ÄÂèòÈáè
                    allServerFiles = data.files;
                    
                    // Êó∂Èó¥ÈôçÂ∫èÊéíÂàó
                    allServerFiles.sort((a, b) => {
                        // ÁõÆÂΩï‰ºòÂÖà‰∫éÊñá‰ª∂
                        if (a.type === 'directory' && b.type !== 'directory') return -1;
                        if (a.type !== 'directory' && b.type === 'directory') return 1;
                        const timeA = new Date(a.modified).getTime();
                        const timeB = new Date(b.modified).getTime();
                        return timeB - timeA;
                    });

                    // Â∫îÁî®Êú¨Âú∞ËøáÊª§
                    applyLocalFilter();
                } else if (data.success) {
                    // Êõ¥Êñ∞ÂΩìÂâçË∑ØÂæÑ
                    currentServerPath = data.current_path || '/';
                    document.getElementById('currentPath').value = currentServerPath;
                    
                    // Êõ¥Êñ∞ËøîÂõûÊåâÈíÆÁä∂ÊÄÅ
                    updateBackButton();
                    
                    // Ê∏ÖÁ©∫ÊâÄÊúâÊúçÂä°Âô®Êñá‰ª∂
                    allServerFiles = [];
                    
                    serverFileList.innerHTML = `
                        <div class="empty-state">
                            <div>üåê</div>
                            <div>ÊúçÂä°Âô®ÁõÆÂΩï‰∏∫Á©∫</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">‰∏ä‰º†Êñá‰ª∂ÂêéÂà∑Êñ∞Êü•Áúã</div>
                        </div>
                    `;
                    document.getElementById('serverFileCount').textContent = '(0)';
                } else {
                    serverFileList.innerHTML = `
                        <div class="empty-state">
                            <div>‚ùå</div>
                            <div>Âä†ËΩΩÂ§±Ë¥•</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">${data.error || 'Êú™Áü•ÈîôËØØ'}</div>
                        </div>
                    `;
                    document.getElementById('serverFileCount').textContent = '(0)';
                }
                
                // Êõ¥Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÈÄâÊã©Áä∂ÊÄÅ
                updateServerFileCounts();
            } catch (error) {
                serverFileList.innerHTML = `
                    <div class="empty-state">
                        <div>‚ùå</div>
                        <div>Âä†ËΩΩÂ§±Ë¥•</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">${error}</div>
                    </div>
                `;
                document.getElementById('serverFileCount').textContent = '(0)';
            }
        }

        // Â∫îÁî®Êú¨Âú∞ËøáÊª§Ôºà‰∏çÈáçÊñ∞ËØ∑Ê±ÇÊúçÂä°Âô®Ôºâ
        function applyLocalFilter() {
            const serverFileList = document.getElementById('serverFileList');
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ÂàóË°®
            serverFileList.innerHTML = '';
            
            if (allServerFiles.length === 0) {
                serverFileList.innerHTML = `
                    <div class="empty-state">
                        <div>üåê</div>
                        <div>ÊúçÂä°Âô®ÁõÆÂΩï‰∏∫Á©∫</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">‰∏ä‰º†Êñá‰ª∂ÂêéÂà∑Êñ∞Êü•Áúã</div>
                    </div>
                `;
                document.getElementById('serverFileCount').textContent = '(0)';
                return;
            }
            
            // ÊåâÁ±ªÂûãÂíåÊó∂Èó¥ÊéíÂ∫è
            const sortedFiles = allServerFiles.sort((a, b) => {
                // ÁõÆÂΩï‰ºòÂÖà‰∫éÊñá‰ª∂
                if (a.type === 'directory' && b.type !== 'directory') return -1;
                if (a.type !== 'directory' && b.type === 'directory') return 1;
                // Êó∂Èó¥ÈôçÂ∫èÊéíÂàó
                const timeA = new Date(a.modified).getTime();
                const timeB = new Date(b.modified).getTime();
                return timeB - timeA;
            });
            
            // Â∫îÁî®3MFËøáÊª§Âô®
            const filteredFiles = filter3mfOnly ? 
                sortedFiles.filter(file => file.type === 'directory' || file.name.toLowerCase().endsWith('.3mf')) :
                sortedFiles;
            
            filteredFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileIcon = file.type === 'directory' ? 
                    '<span class="file-icon file-type-directory">üìÅ</span>' : 
                    '<span class="file-icon file-type-file">üìÑ</span>';
                
                if (file.type === 'directory') {
                    // Êñá‰ª∂Â§π - Ê≤°ÊúâÂ§çÈÄâÊ°Ü
                    fileItem.innerHTML = `
                        <div class="file-info" onclick="handleServerFileClick('${file.name}', '${file.type}')" style="cursor: pointer;">
                            ${fileIcon}
                            <div class="file-name">${file.name}</div>
                        </div>
                    `;
                } else {
                    // Êñá‰ª∂ - ÊúâÂ§çÈÄâÊ°Ü
                    const escapedName = file.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    fileItem.innerHTML = `
                        <input type="checkbox" class="server-file-checkbox" value="${escapedName}" data-type="${file.type}" data-path="${currentServerPath}">
                        <div class="file-info" onclick="handleServerFileClick('${escapedName}', '${file.type}')">
                            ${fileIcon}
                            <div class="file-name">${file.name}</div>
                            <div class="file-details">
                                <span>Â§ßÂ∞è: ${file.size_formatted}</span>
                                <span>Êó∂Èó¥: ${file.modified}</span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-primary btn-small" title="‰∏ãËΩΩÊñá‰ª∂" onclick="event.stopPropagation(); downloadServerFile('${escapedName}')">
                                üì•
                            </button>
                            <button class="btn btn-danger btn-small" title="Âà†Èô§Êñá‰ª∂" onclick="event.stopPropagation(); deleteServerFile('${escapedName}', '${file.type}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                    
                    // ‰∏∫ÊúçÂä°Âô®Êñá‰ª∂Â§çÈÄâÊ°ÜÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
                    const checkbox = fileItem.querySelector('.server-file-checkbox');
                    checkbox.addEventListener('change', updateFileCounts);
                }
                
                serverFileList.appendChild(fileItem);
            });
            
            // Êõ¥Êñ∞ÊúçÂä°Âô®Êñá‰ª∂Êï∞Èáè
            document.getElementById('serverFileCount').textContent = `(${filteredFiles.length})`;
            
            // Êõ¥Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÈÄâÊã©Áä∂ÊÄÅ
            updateServerFileCounts();
            updateFileCounts();
        }

        // Ëé∑ÂèñÁà∂ÁõÆÂΩïË∑ØÂæÑ
        function getParentPath(path) {
            if (!path || path === '/') {
                return '/';
            }
            // ÁßªÈô§Êú´Â∞æÁöÑÊñúÊù†ÔºàÂ¶ÇÊûúÊúâÔºâ
            let normalizedPath = path.replace(/\/$/, '');
            // ÊâæÂà∞ÊúÄÂêé‰∏Ä‰∏™ÊñúÊù†ÁöÑ‰ΩçÁΩÆ
            const lastSlashIndex = normalizedPath.lastIndexOf('/');
            if (lastSlashIndex === -1) {
                return '/';
            }
            // Ëé∑ÂèñÁà∂ÁõÆÂΩïË∑ØÂæÑ
            const parentPath = normalizedPath.substring(0, lastSlashIndex);
            // Â¶ÇÊûúÁà∂ÁõÆÂΩï‰∏∫Á©∫ÔºåËøîÂõûÊ†πÁõÆÂΩï
            return parentPath || '/';
        }

        // Â§ÑÁêÜÊúçÂä°Âô®Êñá‰ª∂ÁÇπÂáª‰∫ã‰ª∂
        function handleServerFileClick(filename, type) {
            if (type === 'directory') {
                // ËøõÂÖ•ÁõÆÂΩï
                let newPath;
                if (currentServerPath === '/') {
                    newPath = `/${filename}`;
                } else {
                    newPath = `${currentServerPath}/${filename}`;
                }
                loadServerFiles(newPath);
            } else {
                // Êñá‰ª∂ÁÇπÂáª - ÂàáÊç¢Â§çÈÄâÊ°ÜÁä∂ÊÄÅ
                const checkbox = document.querySelector(`.server-file-checkbox[value="${filename}"]`);
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    updateFileCounts();
                }
            }
        }

        // ËøîÂõû‰∏ä‰∏ÄÁ∫ßÁõÆÂΩï
        function goBack() {
            const parentPath = getParentPath(currentServerPath);
            if (parentPath !== currentServerPath) {
                loadServerFiles(parentPath);
            }
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöË∑ØÂæÑ
        function goToPath() {
            const path = document.getElementById('currentPath').value.trim();
            if (path) {
                loadServerFiles(path);
            }else{
                loadServerFiles('/');
            }
        }

        // Êõ¥Êñ∞ËøîÂõûÊåâÈíÆÁä∂ÊÄÅ
        function updateBackButton() {
            const backBtn = document.getElementById('backBtn');
            backBtn.disabled = currentServerPath === '/';
        }

        // ËæìÂÖ•Ê°ÜÂõûËΩ¶ÈîÆÊîØÊåÅ
        function setupPathInputEvents() {
            const pathInput = document.getElementById('currentPath');
            
            // ÁõëÂê¨ÂõûËΩ¶ÈîÆ
            pathInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    goToPath();
                }
            });
            
            // ÁõëÂê¨ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπ‰∫ã‰ª∂ÔºåÊñπ‰æøÁî®Êà∑ÂÖ®ÈÄâÊñáÊú¨
            pathInput.addEventListener('focus', function() {
                // Âª∂ËøüÂÖ®ÈÄâÔºåÁ°Æ‰øùÁÑ¶ÁÇπÂ∑≤ÁªèËÆæÁΩÆ
                setTimeout(() => {
                    this.select();
                }, 50);
            });
        }

        // ÂàáÊç¢3MFËøáÊª§Âô®
        function toggle3mfFilter() {
            filter3mfOnly = document.getElementById('filter3mf').checked;
            
            // Êú¨Âú∞ËøáÊª§
            if (allServerFiles.length > 0) {
                applyLocalFilter();
            } else {
                // Ê≤°ÊúâÊï∞ÊçÆÔºåÈáçÊñ∞Âä†ËΩΩ
                loadServerFiles(currentServerPath);
            }
        }

        // Êõ¥Êñ∞Êñá‰ª∂ËÆ°Êï∞
        function updateFileCounts() {
            const localCheckboxes = document.querySelectorAll('.file-checkbox');
            const serverCheckboxes = document.querySelectorAll('.server-file-checkbox');
            
            const localCheckedCount = Array.from(localCheckboxes).filter(cb => cb.checked).length;
            const serverCheckedCount = Array.from(serverCheckboxes).filter(cb => cb.checked).length;
            const totalCheckedCount = localCheckedCount + serverCheckedCount;
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Êñá‰ª∂Êï∞ÈáèÊòæÁ§∫
            document.getElementById('selectedFileCount').textContent = `(${totalCheckedCount})`;
            
            // Êõ¥Êñ∞Êú¨Âú∞Êñá‰ª∂ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
            const selectAll = document.getElementById('selectAll');
            selectAll.checked = localCheckedCount === localCheckboxes.length && localCheckboxes.length > 0;
            selectAll.indeterminate = localCheckedCount > 0 && localCheckedCount < localCheckboxes.length;
            
            // Êõ¥Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
            const selectAllServer = document.getElementById('selectAllServer');
            if (selectAllServer) {
                selectAllServer.checked = serverCheckedCount === serverCheckboxes.length && serverCheckboxes.length > 0;
                selectAllServer.indeterminate = serverCheckedCount > 0 && serverCheckedCount < serverCheckboxes.length;
            }
        }

        // Êõ¥Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ËÆ°Êï∞
        function updateServerFileCounts() {
            const checkboxes = document.querySelectorAll('.server-file-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            // Êõ¥Êñ∞ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
            const selectAllServer = document.getElementById('selectAllServer');
            selectAllServer.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAllServer.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }
        
        // Âà∑Êñ∞Êú¨Âú∞Êñá‰ª∂ÂàóË°®
        function refreshFiles() {
            loadFiles();
        }
        
        // Âà∑Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÂàóË°®
        function refreshServerFiles() {
            loadServerFiles(currentServerPath);
        }
        
        // ÂèñÊ∂àÂçï‰∏™Êñá‰ª∂‰∏ãËΩΩ
        async function cancelDownload() {
            try {
                // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                if (!confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂à‰∏ãËΩΩÂêóÔºüÂ∑≤‰∏ãËΩΩÁöÑÈÉ®ÂàÜÊï∞ÊçÆÂ∞Ü‰ºöË¢´Âà†Èô§„ÄÇ')) {
                    return;
                }
                isDownloadCancelling = true;
                // Á¶ÅÁî®ÂèñÊ∂àÊåâÈíÆÔºåÈÅøÂÖçÈáçÂ§çÁÇπÂáª
                const cancelBtn = document.getElementById('cancelDownloadBtn');
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = 'Ê≠£Âú®ÂèñÊ∂à...';
                
                // Ë∞ÉÁî®ÂèñÊ∂à‰∏ãËΩΩAPI
                const response = await fetch('./api/cancel-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ÂÅúÊ≠¢ËøõÂ∫¶ËΩÆËØ¢
                    stopDownloadProgressPolling();
                    
                    // Âª∂ËøüÂÖ≥Èó≠ÂºπÁ™óÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÂèñÊ∂àÊ∂àÊÅØ
                    setTimeout(() => {
                        closeDownloadProgressModal();
                    }, 200);
                } else {
                    cancelBtn.disabled = false;
                    cancelBtn.innerHTML = '‚ùå ÂèñÊ∂à‰∏ãËΩΩ';
                    showErrorModal('ÂèñÊ∂à‰∏ãËΩΩÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                const cancelBtn = document.getElementById('cancelDownloadBtn');
                cancelBtn.disabled = false;
                cancelBtn.innerHTML = '‚ùå ÂèñÊ∂à‰∏ãËΩΩ';
                showErrorModal('ÂèñÊ∂à‰∏ãËΩΩÂ§±Ë¥•: ' + error);
            }
        }

        // ÂèñÊ∂àÊâπÈáè‰∏ãËΩΩ
        async function cancelBatchDownload() {
            try {
                // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                if (!confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÊâπÈáè‰∏ãËΩΩÂêóÔºüÊú™‰∏ãËΩΩÂÆåÊàêÁöÑÈÉ®ÂàÜÊï∞ÊçÆÂ∞Ü‰ºöË¢´Âà†Èô§„ÄÇ‰∏çÂΩ±ÂìçÂ∑≤Áªè‰∏ãËΩΩÂÆåÊàêÁöÑÊñá‰ª∂')) {
                    return;
                }
                isDownloadCancelling = true;
                // Á¶ÅÁî®ÂèñÊ∂àÊåâÈíÆÔºåÈÅøÂÖçÈáçÂ§çÁÇπÂáª
                const cancelBtn = document.getElementById('cancelBatchDownloadBtn');
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = 'Ê≠£Âú®ÂèñÊ∂à...';
                
                // Ë∞ÉÁî®ÂèñÊ∂à‰∏ãËΩΩAPI
                const response = await fetch('./api/cancel-download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ÂÅúÊ≠¢ËøõÂ∫¶ËΩÆËØ¢
                    stopBatchDownloadProgressPolling();
                    
                    // Âª∂ËøüÂÖ≥Èó≠ÂºπÁ™óÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÂèñÊ∂àÊ∂àÊÅØ
                    setTimeout(() => {
                        closeBatchDownloadProgressModal();
                    }, 200);
                } else {
                    cancelBtn.disabled = false;
                    cancelBtn.innerHTML = '‚ùå ÂèñÊ∂àÊâπÈáè‰∏ãËΩΩ';
                    showErrorModal('ÂèñÊ∂àÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                const cancelBtn = document.getElementById('cancelBatchDownloadBtn');
                cancelBtn.disabled = false;
                cancelBtn.innerHTML = '‚ùå ÂèñÊ∂àÊâπÈáè‰∏ãËΩΩ';
                showErrorModal('ÂèñÊ∂àÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•: ' + error);
            }
        }

        // Âà†Èô§Êú¨Âú∞Êñá‰ª∂
        async function deleteLocalFile(filename) {
            if (!filename) return;

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Êú¨Âú∞Êñá‰ª∂ "${filename}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                return;
            }

            showProcessingModal('Âà†Èô§Êñá‰ª∂‰∏≠...');

            try {
                const response = await fetch('./api/delete-local-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename })
                });

                const data = await response.json();

                closeProcessingModal();

                if (data.success) {
                    await loadFiles();
                    showSuccessModal(`Êñá‰ª∂ ${filename} Âà†Èô§ÊàêÂäü`);
                } else {
                    showErrorModal('Âà†Èô§Â§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                closeProcessingModal();
                showErrorModal('Âà†Èô§Â§±Ë¥•: ' + error);
            }
        }

        // ÊâπÈáèÂà†Èô§Êú¨Âú∞Êñá‰ª∂
        async function batchDeleteLocalFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            if (checkboxes.length === 0) {
                showErrorModal('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊñá‰ª∂');
                return;
            }

            const filesToDelete = Array.from(checkboxes).map(cb => cb.getAttribute('data-name') || cb.dataset.name || cb.value);

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${filesToDelete.length} ‰∏™Êú¨Âú∞Êñá‰ª∂ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                return;
            }

            showProcessingModal('ÊâπÈáèÂà†Èô§‰∏≠...');

            let successCount = 0;
            let failCount = 0;
            const failedFiles = [];

            for (const filename of filesToDelete) {
                try {
                    const response = await fetch('./api/delete-local-file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ filename })
                    });

                    const data = await response.json();

                    if (data.success) {
                        successCount++;
                    } else {
                        failCount++;
                        failedFiles.push(`${filename}: ${data.error || 'Êú™Áü•ÈîôËØØ'}`);
                    }
                } catch (error) {
                    failCount++;
                    failedFiles.push(`${filename}: ${error}`);
                }
            }

            closeProcessingModal();
            await loadFiles();

            if (failCount === 0) {
                showSuccessModal(`ÊàêÂäüÂà†Èô§ ${successCount} ‰∏™Êñá‰ª∂`);
            } else {
                let message = `ÊàêÂäüÂà†Èô§ ${successCount} ‰∏™Êñá‰ª∂ÔºåÂ§±Ë¥• ${failCount} ‰∏™Êñá‰ª∂`;
                if (failedFiles.length > 0) {
                    message += `<br><br>Â§±Ë¥•ÁöÑÊñá‰ª∂Ôºö<br>${failedFiles.slice(0, 3).join('<br>')}`;
                    if (failedFiles.length > 3) {
                        message += `<br>... ‰ª•ÂèäÂè¶Â§ñ ${failedFiles.length - 3} ‰∏™Êñá‰ª∂`;
                    }
                }
                showErrorModal(message);
            }
        }

        // Âà†Èô§ÊúçÂä°Âô®Êñá‰ª∂
        async function deleteServerFile(filename, type = 'file') {
            // Â¶ÇÊûúÊòØÁõÆÂΩïÔºåÁõ¥Êé•ËøîÂõûÔºå‰∏çÊâßË°åÂà†Èô§Êìç‰Ωú
            if (type === 'directory') {
                showErrorModal('ÁõÆÂΩïÂà†Èô§ÂäüËÉΩÂ∑≤Á¶ÅÁî®ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÊñπÂºèÁÆ°ÁêÜÁõÆÂΩï');
                return;
            }
            
            const fileTypeText = type === 'directory' ? 'ÁõÆÂΩï' : 'Êñá‰ª∂';
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÊâìÂç∞Êú∫‰∏äÁöÑ${fileTypeText} "${filename}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                return;
            }
            
            showProcessingModal(`Âà†Èô§${fileTypeText}‰∏≠...`);
            
            try {
                const response = await fetch('./api/delete-server-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        filename: filename,
                        path: currentServerPath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeProcessingModal();
                    // Êú¨Âú∞Âà†Èô§Êñá‰ª∂Ôºå‰∏çÈáçÊñ∞ËØ∑Ê±ÇÊúçÂä°Âô®
                    removeFileFromLocalList(filename, false);
                    updateFileCounts();
                } else {
                    closeProcessingModal();
                    showErrorModal('Âà†Èô§Â§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                closeProcessingModal();
                showErrorModal('Âà†Èô§Â§±Ë¥•: ' + error);
            }
        }

        // ÊâπÈáèÂà†Èô§ÊúçÂä°Âô®Êñá‰ª∂
        async function batchDeleteServerFiles() {
            const checkboxes = document.querySelectorAll('.server-file-checkbox:checked');
            if (checkboxes.length === 0) {
                showErrorModal('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊñá‰ª∂');
                return;
            }

            // ËøáÊª§Âá∫Êñá‰ª∂Ôºà‰∏çÂåÖÊã¨ÁõÆÂΩïÔºâÔºåÁ°Æ‰øùÂè™Âà†Èô§Êñá‰ª∂
            const filesToDelete = Array.from(checkboxes)
                .filter(cb => cb.getAttribute('data-type') === 'file')
                .map(cb => cb.value);

            if (filesToDelete.length === 0) {
                showErrorModal('ËØ∑ÈÄâÊã©Êñá‰ª∂ËøõË°åÂà†Èô§ÔºàÁõÆÂΩï‰∏çÊîØÊåÅÊâπÈáèÂà†Èô§Ôºâ');
                return;
            }

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${filesToDelete.length} ‰∏™Êñá‰ª∂ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                return;
            }

            showBatchDeleteProgress(filesToDelete, 0);

            try {
                let successCount = 0;
                let failCount = 0;
                const failedFiles = [];

                // ÈÄê‰∏™Âà†Èô§Êñá‰ª∂
                for (const filename of filesToDelete) {
                    try {
                        const response = await fetch('./api/delete-server-file', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                filename: filename,
                                path: currentServerPath
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            successCount++;
                            updateBatchDeleteProgress(filesToDelete, successCount)
                            // ‰ªéÊú¨Âú∞ÈòüÂàó‰∏≠Âà†Èô§
                            removeFileFromLocalList(filename, false);
                            updateFileCounts();
                        } else {
                            failCount++;
                            failedFiles.push(`${filename}: ${data.error}`);
                        }
                    } catch (error) {
                        failCount++;
                        failedFiles.push(`${filename}: ${error}`);
                    }
                }
                
                closeProcessingModal();
                
                if (failCount === 0) {
                    showSuccessModal(`ÊàêÂäüÂà†Èô§ ${successCount} ‰∏™Êñá‰ª∂`);
                } else {
                    let message = `ÊàêÂäüÂà†Èô§ ${successCount} ‰∏™Êñá‰ª∂ÔºåÂ§±Ë¥• ${failCount} ‰∏™Êñá‰ª∂`;
                    if (failedFiles.length > 0) {
                        message += `<br><br>Â§±Ë¥•ÁöÑÊñá‰ª∂Ôºö<br>${failedFiles.slice(0, 3).join('<br>')}`;
                        if (failedFiles.length > 3) {
                            message += `<br>... ‰ª•ÂèäÂè¶Â§ñ ${failedFiles.length - 3} ‰∏™Êñá‰ª∂`;
                        }
                    }
                    showErrorModal(message);
                }
            } catch (error) {
                closeProcessingModal();
                showErrorModal('ÊâπÈáèÂà†Èô§Â§±Ë¥•: ' + error);
            }
        }

        // ÊâπÈáèÂà†Èô§ËøõÂ∫¶ÂºπÁ™ó
        function showBatchDeleteProgress(filesToDelete, currentIndex) {
            const totalFiles = filesToDelete.length;
            const currentFile = currentIndex < totalFiles ? filesToDelete[currentIndex] : '';
            
            const progressPercentage = Math.round((currentIndex / totalFiles) * 100);
            
            const progressHtml = `
                <div style="text-align: center;">
                    <div style="margin: 15px 0; font-size: 1.1em; color: #2c3e50;">
                        Ê≠£Âú®Âà†Èô§Êñá‰ª∂ ${currentIndex + 1}/${totalFiles}
                    </div>
                    <div style="margin: 10px 0; font-size: 0.9em; color: #6c757d;">
                        ÂΩìÂâçÊñá‰ª∂: ${currentFile}
                    </div>
                    <div style="margin: 15px 0; background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(135deg, #3498db, #2980b9); width: ${progressPercentage}%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">
                            ${progressPercentage}%
                        </div>
                    </div>
                </div>
            `;
            
            showProcessingModal(progressHtml);
        }

        // Êõ¥Êñ∞ÊâπÈáèÂà†Èô§ËøõÂ∫¶ÊòæÁ§∫
        function updateBatchDeleteProgress(filesToDelete, currentIndex) {
            successCount = currentIndex + 1;
            const totalFiles = filesToDelete.length;
            const progressPercentage = Math.round(((currentIndex + 1) / totalFiles) * 100);
            const currentFile = currentIndex < totalFiles ? filesToDelete[currentIndex] : '';
            const processingModal = document.getElementById('processingModal');
            const processingMessage = document.getElementById('processingModalMessage');
            if (processingMessage) {
                processingMessage.innerHTML = `
                    <div style="margin: 10px 0; font-size: 1em; color: #2c3e50;">
                        Ê≠£Âú®Âà†Èô§Êñá‰ª∂ ${currentIndex + 1}/${totalFiles}
                    </div>
                    <div style="margin: 8px 0; font-size: 0.9em; color: #6c757d;">
                        ÂΩìÂâçÊñá‰ª∂: ${currentFile}
                    </div>
                    <div style="margin: 15px 0; background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(135deg, #3498db, #2980b9); width: ${progressPercentage}%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">
                            ${progressPercentage}%
                        </div>
                    </div>
                `;
            }
            processingModal.style.display = 'flex';
        }

        // ‰ªéÊú¨Âú∞Êñá‰ª∂ÂàóË°®‰∏≠Âà†Èô§Êñá‰ª∂
        function removeFileFromLocalList(filename, showSuccess = true) {
            // ‰ªé allServerFiles ‰∏≠Âà†Èô§Êñá‰ª∂
            const initialLength = allServerFiles.length;
            allServerFiles = allServerFiles.filter(file => file.name !== filename);
            
            if (allServerFiles.length < initialLength) {
                
                // ÈáçÊñ∞Â∫îÁî®ËøáÊª§Âπ∂Ê∏≤Êüì
                applyLocalFilter();
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                if (showSuccess) {
                    showSuccessModal(`Êñá‰ª∂ ${filename} Âà†Èô§ÊàêÂäü`);
                }
            } else {
                console.warn(`Êú™ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑÊñá‰ª∂: ${filename}ÔºåÈáçÊñ∞Âä†ËΩΩÂàóË°®`);
                // Â¶ÇÊûúÊú¨Âú∞Ê≤°ÊâæÂà∞ÔºåÈáçÊñ∞Âä†ËΩΩÊúçÂä°Âô®Êñá‰ª∂ÂàóË°®
                loadServerFiles(currentServerPath);
            }
        }

        // ‰∏ãËΩΩÊúçÂä°Âô®Êñá‰ª∂
        async function downloadServerFile(filename) {
            isDownloadCancelling = false;
            const fileItem = findFileItemByName(filename);
            let fileSize = 0;
            
            if (fileItem) {
                // Â∞ùËØï‰ªéÊñá‰ª∂ËØ¶ÊÉÖ‰∏≠Ëß£ÊûêÊñá‰ª∂Â§ßÂ∞è
                const fileDetails = fileItem.querySelector('.file-details');
                if (fileDetails) {
                    const sizeSpan = fileDetails.querySelector('span');
                    if (sizeSpan) {
                        const sizeText = sizeSpan.textContent.replace('Â§ßÂ∞è: ', '');
                        fileSize = parseFileSize(sizeText);
                    }
                }
            }
            // ÊòæÁ§∫‰∏ãËΩΩËøõÂ∫¶ÂºπÁ™ó
            showDownloadProgressModal(filename, fileSize);
            // ÂºÄÂßãËΩÆËØ¢‰∏ãËΩΩËøõÂ∫¶
            startDownloadProgressPolling();
            
            // ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥
            downloadStartTime = Date.now();
            lastDownloadedBytes = 0;

            try {
                const response = await fetch('./api/download-server-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        filename: filename,
                        path: currentServerPath,
                        total_bytes: fileSize  // ‰º†ÈÄíÊñá‰ª∂ÊÄªÂ§ßÂ∞è
                    })
                });

                const data = await response.json();

                // ÂÅúÊ≠¢ËΩÆËØ¢
                stopDownloadProgressPolling();

                if (data.success) {
                    closeDownloadProgressModal();
                    
                    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                    const downloadLink = document.createElement('a');
                    downloadLink.href = withRuntimePath(`/tempDownload/${filename}`);
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none';
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    // Âª∂ËøüÂêéÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    setTimeout(() => {}, 20);
                } else {
                    closeDownloadProgressModal();
                    // Â¶ÇÊûú‰∏çÊòØÁî®Êà∑ÂèñÊ∂àÔºåÊòæÁ§∫ÈîôËØØ
                    if (!isDownloadCancelling) {
                        showErrorModal('‰∏ãËΩΩÂ§±Ë¥•: ' + data.error);
                    }
                }
            } catch (error) {
                stopDownloadProgressPolling();
                closeDownloadProgressModal();
                if (!isDownloadCancelling) {
                    showErrorModal('‰∏ãËΩΩÂ§±Ë¥•: ' + error);
                }
            }
        }

        // ÊâπÈáè‰∏ãËΩΩÊúçÂä°Âô®Êñá‰ª∂
        async function batchDownloadServerFiles() {
            const checkboxes = document.querySelectorAll('.server-file-checkbox:checked');
            if (checkboxes.length === 0) {
                showErrorModal('ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰∏ãËΩΩÁöÑÊñá‰ª∂');
                return;
            }

            // ËøáÊª§Âá∫Êñá‰ª∂Ôºà‰∏çÂåÖÊã¨ÁõÆÂΩïÔºâ
            const filesToDownload = Array.from(checkboxes)
                .filter(cb => cb.getAttribute('data-type') === 'file')
                .map(cb => {
                    // Êü•ÊâæÊñá‰ª∂‰ø°ÊÅØËé∑ÂèñÊñá‰ª∂Â§ßÂ∞è
                    const fileItem = cb.closest('.file-item');
                    const fileDetails = fileItem.querySelector('.file-details');
                    let sizeText = '0 B';
                    if (fileDetails) {
                        const sizeSpan = fileDetails.querySelector('span');
                        if (sizeSpan) {
                            sizeText = sizeSpan.textContent.replace('Â§ßÂ∞è: ', '');
                        }
                    }
                    
                    return {
                        name: cb.value,
                        path: currentServerPath,
                        size: parseFileSize(sizeText) || 0
                    };
                });

            if (filesToDownload.length === 0) {
                showErrorModal('ËØ∑ÈÄâÊã©Êñá‰ª∂ËøõË°å‰∏ãËΩΩÔºàÁõÆÂΩï‰∏çÊîØÊåÅ‰∏ãËΩΩÔºâ');
                return;
            }
            // ÊòæÁ§∫ÊâπÈáè‰∏ãËΩΩÂºπÁ™ó
            showBatchDownloadProgressModal(filesToDownload);
            // Ê∏ÖÁêÜÂ∑≤‰øùÂ≠òËÆ∞ÂΩïÔºåÈÅøÂÖç‰∏äÊ¨°ÊâπÈáè‰∏ãËΩΩÁöÑÊñá‰ª∂ÂÜçÊ¨°Ëß¶Âèë‰øùÂ≠ò
            batchSavedSet.clear();
            startBatchDownloadProgressPolling();
            
            try {
                const response = await fetch('./api/batch-download-server-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        files: filesToDownload
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // ËøõÂ∫¶ËΩÆËØ¢‰ºöÂú®ÂêéÂè∞ÁªßÁª≠Êõ¥Êñ∞
                } else {
                    stopBatchDownloadProgressPolling();
                    closeBatchDownloadProgressModal();
                    showErrorModal('ÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                stopBatchDownloadProgressPolling();
                closeBatchDownloadProgressModal();
                showErrorModal('ÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•: ' + error);
            }
        }

        // ÈÄöËøáÊñá‰ª∂ÂêçÊü•ÊâæÊñá‰ª∂È°π
        function findFileItemByName(filename) {
            const fileItems = document.querySelectorAll('.file-item');
            for (const item of fileItems) {
                const checkbox = item.querySelector('.server-file-checkbox');
                if (checkbox && checkbox.value === filename) {
                    return item;
                }
            }
            return null;
        }

        // Ëß£ÊûêÊñá‰ª∂Â§ßÂ∞èÂ≠óÁ¨¶‰∏≤‰∏∫Â≠óËäÇÊï∞
        function parseFileSize(sizeString) {
            if (!sizeString || sizeString === 'Â§ßÂ∞è: -') {
                return 0;
            }
            
            const units = {
                'B': 1,
                'KB': 1024,
                'MB': 1024 * 1024,
                'GB': 1024 * 1024 * 1024
            };
            
            try {
                // ÁßªÈô§"Â§ßÂ∞è: "ÂâçÁºÄ
                sizeString = sizeString.replace('Â§ßÂ∞è: ', '').trim();
                
                // Ëß£ÊûêÊï∞Â≠óÂíåÂçï‰Ωç
                const match = sizeString.match(/^([\d.]+)\s*([KMG]?B)$/i);
                if (match) {
                    const value = parseFloat(match[1]);
                    const unit = match[2].toUpperCase();
                    return value * (units[unit] || 1);
                }
                
                // Â∞ùËØïÁõ¥Êé•Ëß£ÊûêÁ∫ØÊï∞Â≠ó
                const numericValue = parseFloat(sizeString);
                if (!isNaN(numericValue)) {
                    return numericValue;
                }
                
                return 0;
            } catch (error) {
                console.error('Ëß£ÊûêÊñá‰ª∂Â§ßÂ∞èÂ§±Ë¥•:', error, 'ÂéüÂßãÂ≠óÁ¨¶‰∏≤:', sizeString);
                return 0;
            }
        }

        // ÊòæÁ§∫‰∏ãËΩΩËøõÂ∫¶ÂºπÁ™ó
        function showDownloadProgressModal(filename, fileSize) {
            const downloadModal = document.getElementById('downloadModal');
            const downloadMessage = document.getElementById('downloadModalMessage');
            const downloadCurrentFile = document.getElementById('downloadCurrentFile');
            const cancelBtn = document.getElementById('cancelDownloadBtn');
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '‚ùå ÂèñÊ∂à‰∏ãËΩΩ';
            downloadCurrentFile.textContent = `ÂΩìÂâçÊñá‰ª∂: ${filename}`;
            
            // ÂàùÂßãÂåñËøõÂ∫¶Êù°
            updateDownloadProgressUI(0, 0, fileSize, filename);
            
            downloadModal.style.display = 'flex';
        }

        // ÂÖ≥Èó≠‰∏ãËΩΩËøõÂ∫¶ÂºπÁ™ó
        function closeDownloadProgressModal() {
            const downloadModal = document.getElementById('downloadModal');
            downloadModal.style.display = 'none';
            stopDownloadProgressPolling();
        }

        // ÊòæÁ§∫ÊâπÈáè‰∏ãËΩΩËøõÂ∫¶ÂºπÁ™ó
        function showBatchDownloadProgressModal(files) {
            const batchDownloadModal = document.getElementById('batchDownloadModal');
            const batchDownloadSummary = document.getElementById('batchDownloadSummary');
            const batchDownloadFileList = document.getElementById('batchDownloadFileList');
            const cancelBtn = document.getElementById('cancelBatchDownloadBtn');
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '‚ùå ÂèñÊ∂à‰∏ãËΩΩ';
            
            // ËÆ°ÁÆóÊÄªÂ§ßÂ∞è
            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const totalSizeFormatted = formatFileSize(totalSize);
            
            // Êõ¥Êñ∞ÊëòË¶Å
            batchDownloadSummary.innerHTML = `
                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                    ÂáÜÂ§á‰∏ãËΩΩ ${files.length} ‰∏™Êñá‰ª∂ÔºåÊÄªÂ§ßÂ∞è: ${totalSizeFormatted}
                </div>
                <div style="font-size: 0.9em; color: #6c757d;">
                    ‰∏ãËΩΩÁöÑÊñá‰ª∂Â∞Ü‰øùÂ≠òÂú®ÊµèËßàÂô®ÈªòËÆ§‰∏ãËΩΩ‰ΩçÁΩÆ
                </div>
            `;
            
            // Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®
            let fileListHTML = '';
            files.forEach(file => {
                const sizeFormatted = formatFileSize(file.size);
                fileListHTML += `
                    <div class="batch-download-file-item">
                        <span class="batch-download-file-name">${file.name}</span>
                        <span class="batch-download-file-size">${sizeFormatted}</span>
                    </div>
                `;
            });
            batchDownloadFileList.innerHTML = fileListHTML;
            
            // ÂàùÂßãÂåñËøõÂ∫¶
            updateBatchDownloadProgressUI(0, 0, totalSize, 0, files.length, '');
            
            batchDownloadModal.style.display = 'flex';
        }

        // ÂÖ≥Èó≠ÊâπÈáè‰∏ãËΩΩËøõÂ∫¶ÂºπÁ™ó
        function closeBatchDownloadProgressModal() {
            const batchDownloadModal = document.getElementById('batchDownloadModal');
            batchDownloadModal.style.display = 'none';
            stopBatchDownloadProgressPolling();
        }

        // ÂºÄÂßãËΩÆËØ¢‰∏ãËΩΩËøõÂ∫¶
        function startDownloadProgressPolling() {
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑËΩÆËØ¢
            if (downloadPollingInterval) {
                clearInterval(downloadPollingInterval);
            }
            
            // ÊØè500ÊØ´ÁßíËé∑Âèñ‰∏ÄÊ¨°ËøõÂ∫¶
            downloadPollingInterval = setInterval(fetchDownloadProgress, 500);
            lastDownloadProgressUpdate = Date.now();
        }

        // ÂÅúÊ≠¢ËΩÆËØ¢‰∏ãËΩΩËøõÂ∫¶
        function stopDownloadProgressPolling() {
            if (downloadPollingInterval) {
                clearInterval(downloadPollingInterval);
                downloadPollingInterval = null;
            }
        }

        // ÂºÄÂßãËΩÆËØ¢ÊâπÈáè‰∏ãËΩΩËøõÂ∫¶
        function startBatchDownloadProgressPolling() {
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑËΩÆËØ¢
            if (batchDownloadPollingInterval) {
                clearInterval(batchDownloadPollingInterval);
            }
            
            // ÊØè500ÊØ´ÁßíËé∑Âèñ‰∏ÄÊ¨°ËøõÂ∫¶
            batchDownloadPollingInterval = setInterval(fetchDownloadProgress, 500);
            lastDownloadProgressUpdate = Date.now();
        }

        // ÂÅúÊ≠¢ËΩÆËØ¢ÊâπÈáè‰∏ãËΩΩËøõÂ∫¶
        function stopBatchDownloadProgressPolling() {
            if (batchDownloadPollingInterval) {
                clearInterval(batchDownloadPollingInterval);
                batchDownloadPollingInterval = null;
            }
        }

        // Ëé∑Âèñ‰∏ãËΩΩËøõÂ∫¶
        async function fetchDownloadProgress() {
            try {
                const response = await fetch('./api/download-progress');
                const progress = await response.json();
                
                // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
                lastDownloadProgressUpdate = Date.now();
                
                // Êõ¥Êñ∞UI
                if (progress.total_files > 1) {
                    // ÊâπÈáè‰∏ãËΩΩ
                    updateBatchDownloadProgressFromAPI(progress);
                } else {
                    // Âçï‰∏™Êñá‰ª∂‰∏ãËΩΩ
                    updateDownloadProgressFromAPI(progress);
                }
                
                // Â§ÑÁêÜ‰∏çÂêåÁöÑÁä∂ÊÄÅ
                if (progress.status === 'cancelled') {
                    // ‰∏ãËΩΩË¢´ÂèñÊ∂à
                    stopDownloadProgressPolling();
                    stopBatchDownloadProgressPolling();
                    
                    // Âª∂ËøüÂêéÂÖ≥Èó≠ÂºπÁ™ó
                    setTimeout(() => {
                        closeDownloadProgressModal();
                        closeBatchDownloadProgressModal();
                    }, 500);
                    
                } else if (progress.status === 'success' || progress.status === 'error' || progress.status === 'completed') {
                    // ‰∏ãËΩΩÂÆåÊàêÊàñÂá∫Èîô
                    stopDownloadProgressPolling();
                    stopBatchDownloadProgressPolling();
                    
                    // Âª∂ËøüÂêéÂÖ≥Èó≠ÂºπÁ™óÂπ∂ÊòæÁ§∫ÁªìÊûú
                    setTimeout(() => {
                        if (progress.status === 'success') {
                            closeDownloadProgressModal();
                            closeBatchDownloadProgressModal();
                            showSuccessModal(progress.message || '‰∏ãËΩΩÂÆåÊàê');
                        } else if (progress.status === 'error') {
                            closeDownloadProgressModal();
                            closeBatchDownloadProgressModal();
                            showErrorModal(progress.message || '‰∏ãËΩΩÂ§±Ë¥•');
                        }
                    }, 1000);
                }
                
                // Â¶ÇÊûúË∂ÖËøá30ÁßíÊ≤°ÊúâÊõ¥Êñ∞ÔºåËÆ§‰∏∫ËøûÊé•ÂèØËÉΩÂ∑≤Êñ≠ÂºÄ
                if (Date.now() - lastDownloadProgressUpdate > 30000) {
                    console.warn('‰∏ãËΩΩËøõÂ∫¶Êõ¥Êñ∞Ë∂ÖÊó∂ÔºåÂèØËÉΩËøûÊé•Â∑≤Êñ≠ÂºÄ');
                    stopDownloadProgressPolling();
                    stopBatchDownloadProgressPolling();
                }
            } catch (error) {
                console.error('Ëé∑Âèñ‰∏ãËΩΩËøõÂ∫¶Â§±Ë¥•:', error);
                // ‰∏çÂÅúÊ≠¢ËΩÆËØ¢ÔºåÂõ†‰∏∫ÂèØËÉΩÊòØ‰∏¥Êó∂ÁΩëÁªúÈóÆÈ¢ò
            }
        }

        // Ê†πÊçÆAPIËøõÂ∫¶Êï∞ÊçÆÊõ¥Êñ∞ÊâπÈáè‰∏ãËΩΩUI
        function updateBatchDownloadProgressFromAPI(progress) {
            const batchDownloadProgressFill = document.getElementById('batchDownloadProgressFill');
            const batchDownloadProgressDetails = document.getElementById('batchDownloadProgressDetails');
            const batchDownloadMessage = document.getElementById('batchDownloadMessage');
            const batchDownloadFileProgress = document.getElementById('batchDownloadFileProgress');
            const batchDownloadFileProgressFill = document.getElementById('batchDownloadFileProgressFill');
            const batchDownloadSummary = document.getElementById('batchDownloadSummary');
            
            // Êõ¥Êñ∞ÊÄª‰ΩìËøõÂ∫¶
            const overallProgress = progress.progress || 0;
            const overallPercentage = Math.min(100, Math.max(0, overallProgress));
            
            batchDownloadProgressFill.style.width = `${overallPercentage}%`;
            batchDownloadProgressFill.textContent = `${overallPercentage.toFixed(1)}%`;
            
            // Êõ¥Êñ∞ÊÄª‰ΩìËøõÂ∫¶ËØ¶ÊÉÖ
            const downloadedFormatted = formatFileSize(progress.downloaded_bytes || 0);
            const totalFormatted = formatFileSize(progress.total_bytes || 0);
            batchDownloadProgressDetails.textContent = 
                `ÊÄª‰ΩìËøõÂ∫¶: ${overallPercentage.toFixed(1)}% (${downloadedFormatted} / ${totalFormatted})`;
            
            // Êõ¥Êñ∞Ê∂àÊÅØ
            if (progress.current_file) {
                batchDownloadMessage.textContent = 
                    `Ê≠£Âú®‰∏ãËΩΩ: ${progress.current_file} (${progress.current_file_index + 1}/${progress.total_files})`;
            } else {
                batchDownloadMessage.textContent = 
                    `Â∑≤Â§ÑÁêÜ ${progress.current_file_index || 0}/${progress.total_files || 1} ‰∏™Êñá‰ª∂`;
            }
            
            // Êõ¥Êñ∞ÂΩìÂâçÊñá‰ª∂ËøõÂ∫¶
            const fileProgress = progress.current_file_progress || 0;
            const fileProgressPercentage = Math.min(100, Math.max(0, fileProgress));
            
            batchDownloadFileProgressFill.style.width = `${fileProgressPercentage}%`;
            batchDownloadFileProgressFill.textContent = `${fileProgressPercentage.toFixed(1)}%`;
            
            if (progress.current_file) {
                const currentDownloaded = progress.current_file_downloaded || 0;
                const currentTotal = progress.current_file_total || 1;
                const currentDownloadedFormatted = formatFileSize(currentDownloaded);
                const currentTotalFormatted = formatFileSize(currentTotal);
                
                batchDownloadFileProgress.innerHTML = `
                    ÂΩìÂâçÊñá‰ª∂: ${progress.current_file}<br>
                    Êñá‰ª∂ËøõÂ∫¶: ${fileProgressPercentage.toFixed(1)}% (${currentDownloadedFormatted} / ${currentTotalFormatted})
                `;
            } else {
                batchDownloadFileProgress.textContent = 'ÂΩìÂâçÊñá‰ª∂: -';
            }
            
            // Êõ¥Êñ∞ÊëòË¶Å‰ø°ÊÅØ
            if (batchDownloadSummary) {
                batchDownloadSummary.innerHTML = `
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                        Ê≠£Âú®‰∏ãËΩΩ ${progress.total_files || 0} ‰∏™Êñá‰ª∂ÔºåÊÄªÂ§ßÂ∞è: ${totalFormatted}
                    </div>
                    <div style="font-size: 0.9em; color: #6c757d;">
                        Â∑≤‰∏ãËΩΩ: ${downloadedFormatted} / ${totalFormatted} (${overallPercentage.toFixed(1)}%)
                    </div>
                `;
            }

            // Â¶ÇÊûúÂêéÁ´ØÂëäÁü•ÊúÄËøëÂ∑≤‰øùÂ≠òÁöÑÂçï‰∏™Êñá‰ª∂ÔºåËß¶ÂèëÊµèËßàÂô®‰øùÂ≠òÔºàÈÅøÂÖçÈáçÂ§çËß¶ÂèëÔºâ
            if (progress.last_saved_url) {
                try {
                    const url = withRuntimePath(progress.last_saved_url);
                    if (!batchSavedSet.has(url)) {
                        batchSavedSet.add(url);
                        const filename = progress.last_saved || decodeURIComponent(url.split('/').pop());
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = filename;
                        downloadLink.style.display = 'none';
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                    }
                } catch (e) {
                    console.warn('Ëá™Âä®‰øùÂ≠òÊâπÈáè‰∏ãËΩΩÊñá‰ª∂Â§±Ë¥•:', e);
                }
            }
        }

        // Ê†πÊçÆAPIËøõÂ∫¶Êï∞ÊçÆÊõ¥Êñ∞UI
        function updateDownloadProgressFromAPI(progress) {
            if (progress.current_file && progress.total_bytes > 0) {
                // Âçï‰∏™Êñá‰ª∂‰∏ãËΩΩ
                const currentTime = Date.now();
                const elapsedTime = (currentTime - downloadStartTime) / 1000; // Áßí
                
                // ËÆ°ÁÆó‰∏ãËΩΩÈÄüÂ∫¶
                let downloadSpeed = 'ËÆ°ÁÆó‰∏≠...';
                if (elapsedTime > 0) {
                    const speed = (progress.downloaded_bytes - lastDownloadedBytes) / elapsedTime;
                    lastDownloadedBytes = progress.downloaded_bytes;
                    
                    if (speed > 0) {
                        downloadSpeed = `${formatFileSize(speed)}/s`;
                    }
                }
                
                updateDownloadProgressUI(
                    progress.progress,
                    progress.downloaded_bytes,
                    progress.total_bytes,
                    progress.current_file,
                    downloadSpeed
                );
                
                // ÈáçÁΩÆÂºÄÂßãÊó∂Èó¥‰ª•‰æøËÆ°ÁÆó‰∏ã‰∏Ä‰∏™ÈÄüÂ∫¶Âå∫Èó¥
                downloadStartTime = currentTime;
            } else if (progress.total_files > 0) {
                // ÊâπÈáè‰∏ãËΩΩ
                const currentFileIndex = progress.current_file_index || 0;
                const totalFiles = progress.total_files || 1;
                const overallProgress = (currentFileIndex / totalFiles) * 100;
                
                updateBatchDownloadProgressUI(
                    overallProgress,
                    progress.downloaded_bytes || 0,
                    progress.total_bytes || 0,
                    currentFileIndex,
                    totalFiles,
                    progress.current_file || '',
                    progress.progress || 0
                );
            }
        }

        // Êõ¥Êñ∞Âçï‰∏™Êñá‰ª∂‰∏ãËΩΩËøõÂ∫¶UI
        function updateDownloadProgressUI(progress, downloadedBytes, totalBytes, filename, downloadSpeed = 'ËÆ°ÁÆó‰∏≠...') {
            const downloadProgressFill = document.getElementById('downloadProgressFill');
            const downloadProgressDetails = document.getElementById('downloadProgressDetails');
            const downloadSpeedElement = document.getElementById('downloadSpeed');
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progressPercentage = Math.min(100, Math.max(0, progress));
            downloadProgressFill.style.width = `${progressPercentage}%`;
            downloadProgressFill.textContent = `${progressPercentage.toFixed(1)}%`;
            
            // Êõ¥Êñ∞ËøõÂ∫¶ËØ¶ÊÉÖ
            const downloadedFormatted = formatFileSize(downloadedBytes);
            const totalFormatted = formatFileSize(totalBytes);
            downloadProgressDetails.innerHTML = `
                <span class="download-progress-file">${filename}</span><br>
                ËøõÂ∫¶: <span class="download-progress-percentage">${progressPercentage.toFixed(1)}%</span><br>
                Â∑≤‰∏ãËΩΩ: ${downloadedFormatted} / ${totalFormatted}
            `;
            
            // Êõ¥Êñ∞‰∏ãËΩΩÈÄüÂ∫¶
            downloadSpeedElement.textContent = `ÈÄüÂ∫¶: ${downloadSpeed}`;
        }

        // Êõ¥Êñ∞ÊâπÈáè‰∏ãËΩΩËøõÂ∫¶UI
        function updateBatchDownloadProgressUI(overallProgress, totalDownloaded, totalSize, currentIndex, totalFiles, currentFilename, fileProgress = 0) {
            const batchDownloadProgressFill = document.getElementById('batchDownloadProgressFill');
            const batchDownloadProgressDetails = document.getElementById('batchDownloadProgressDetails');
            const batchDownloadMessage = document.getElementById('batchDownloadMessage');
            const batchDownloadFileProgress = document.getElementById('batchDownloadFileProgress');
            const batchDownloadFileProgressFill = document.getElementById('batchDownloadFileProgressFill');
            
            // Êõ¥Êñ∞ÊÄª‰ΩìËøõÂ∫¶
            const overallPercentage = Math.min(100, Math.max(0, overallProgress));
            batchDownloadProgressFill.style.width = `${overallPercentage}%`;
            batchDownloadProgressFill.textContent = `${overallPercentage.toFixed(1)}%`;
            
            // Êõ¥Êñ∞ÊÄª‰ΩìËøõÂ∫¶ËØ¶ÊÉÖ
            const totalDownloadedFormatted = formatFileSize(totalDownloaded);
            const totalSizeFormatted = formatFileSize(totalSize);
            batchDownloadProgressDetails.textContent = `ÊÄª‰ΩìËøõÂ∫¶: ${overallPercentage.toFixed(1)}% (${currentIndex}/${totalFiles} ‰∏™Êñá‰ª∂)`;
            
            // Êõ¥Êñ∞Ê∂àÊÅØ
            if (currentFilename) {
                batchDownloadMessage.textContent = `Ê≠£Âú®‰∏ãËΩΩ: ${currentFilename} (${currentIndex}/${totalFiles})`;
            } else {
                batchDownloadMessage.textContent = `Â∑≤‰∏ãËΩΩ ${currentIndex}/${totalFiles} ‰∏™Êñá‰ª∂`;
            }
            
            // Êõ¥Êñ∞ÂΩìÂâçÊñá‰ª∂ËøõÂ∫¶
            const fileProgressPercentage = Math.min(100, Math.max(0, fileProgress));
            batchDownloadFileProgressFill.style.width = `${fileProgressPercentage}%`;
            batchDownloadFileProgressFill.textContent = `${fileProgressPercentage.toFixed(1)}%`;
            
            if (currentFilename) {
                batchDownloadFileProgress.innerHTML = `
                    ÂΩìÂâçÊñá‰ª∂: ${currentFilename}<br>
                    Êñá‰ª∂ËøõÂ∫¶: ${fileProgressPercentage.toFixed(1)}%
                `;
            } else {
                batchDownloadFileProgress.textContent = 'ÂΩìÂâçÊñá‰ª∂: -';
            }
        }

        // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
        function formatFileSize(bytes) {
            if (bytes === 0) return "0 B";
            const sizeNames = ["B", "KB", "MB", "GB"];
            let i = 0;
            let size = bytes;
            while (size >= 1024 && i < sizeNames.length - 1) {
                size /= 1024;
                i++;
            }
            return `${size.toFixed(2)} ${sizeNames[i]}`;
        }

        // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâÊúçÂä°Âô®Êñá‰ª∂
        function toggleSelectAllServer() {
            const selectAll = document.getElementById('selectAllServer');
            const checkboxes = document.querySelectorAll('.server-file-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateServerFileCounts();
            updateFileCounts();
        }

        // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateFileCounts();
        }

        // ÊâìÂºÄÈÖçÁΩÆÂºπÁ™ó
        function openConfigModal() {
            document.getElementById('configModal').style.display = 'block';
        }

        // ÂÖ≥Èó≠ÈÖçÁΩÆÂºπÁ™ó
        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }
        
        // ÊâìÂºÄÊâìÂç∞ÈòüÂàóÈÖçÁΩÆÂºπÁ™ó
        async function openPrintQueueModal() {
            const localCheckboxes = document.querySelectorAll('.file-checkbox:checked');
            const serverCheckboxes = document.querySelectorAll('.server-file-checkbox:checked');
            
            if (localCheckboxes.length === 0 && serverCheckboxes.length === 0) {
                showErrorModal('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂ§ÑÁêÜÁöÑÊñá‰ª∂');
                return;
            }
            
            // Ê£ÄÊü•Êñá‰ª∂ÂêçÈïøÂ∫¶
            const invalidFiles = [];
            // Ê£ÄÊü•Êú¨Âú∞Êñá‰ª∂
            localCheckboxes.forEach(checkbox => {
                const filename = checkbox.getAttribute('data-name');
                if (filename.length > 47) {
                    invalidFiles.push(filename);
                }
            });
            // Ê£ÄÊü•ÊúçÂä°Âô®Êñá‰ª∂
            serverCheckboxes.forEach(checkbox => {
                const filename = checkbox.value;
                if (filename.length > 47) {
                    invalidFiles.push(filename);
                }
            });
            if (invalidFiles.length > 0) {
                let displayFiles = invalidFiles.slice(0, 2);
                let additionalCount = invalidFiles.length - 2;
                
                let errorMessage = `‰ª•‰∏ãÊñá‰ª∂ÂêçË∂ÖËøá47‰∏™Â≠óÁ¨¶ÈôêÂà∂:<br><br>${displayFiles.join('<br>')}`;
                
                if (additionalCount > 0) {
                    errorMessage += `<br>... ‰ª•ÂèäÂè¶Â§ñ ${additionalCount} ‰∏™Êñá‰ª∂`;
                }
                
                errorMessage += `<br><br>Áî±‰∫éÊâìÂç∞Êú∫FTPÈôêÂà∂ÔºåÊñá‰ª∂ÂêçÊúÄÂ§ßÂè™ËÉΩ47‰∏™ÊñáÂ≠óÔºàÂåÖÊã¨ÂêéÁºÄÔºâÔºåËØ∑ÈáçÂëΩÂêçÂêéÂÜçËØï`;
                
                showErrorModal(errorMessage);
                return;
            }
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûãÊòØÂê¶‰∏∫3MF
            const non3mfFiles = [];
            // Ê£ÄÊü•Êú¨Âú∞Êñá‰ª∂Á±ªÂûã
            localCheckboxes.forEach(checkbox => {
                const filename = checkbox.getAttribute('data-name');
                if (!is3mfFile(filename)) {
                    non3mfFiles.push({
                        name: filename,
                        type: 'Êú¨Âú∞Êñá‰ª∂',
                        reason: '‰∏çÊòØ3MFÊñá‰ª∂'
                    });
                }
            });
            // Ê£ÄÊü•ÊúçÂä°Âô®Êñá‰ª∂Á±ªÂûã
            serverCheckboxes.forEach(checkbox => {
                const filename = checkbox.value;
                const fileType = checkbox.getAttribute('data-type');
                // Ë∑≥ËøáÁõÆÂΩï
                if (fileType === 'directory') {
                    non3mfFiles.push({
                        name: filename,
                        type: 'ÊâìÂç∞Êú∫ÁõÆÂΩï',
                        reason: '‰∏çËÉΩÂ§ÑÁêÜÁõÆÂΩï'
                    });
                } else if (!is3mfFile(filename)) {
                    non3mfFiles.push({
                        name: filename,
                        type: 'ÊâìÂç∞Êú∫Êñá‰ª∂',
                        reason: '‰∏çÊòØ3MFÊñá‰ª∂'
                    });
                }
            });
            if (non3mfFiles.length > 0) {
                let errorMessage = `‰ª•‰∏ãÊñá‰ª∂‰∏çÊòØ3MFÊñá‰ª∂Êàñ‰∏çËÉΩÂ§ÑÁêÜ:<br>`;
                non3mfFiles.slice(0, 2).forEach(file => {
                    errorMessage += `<br>${file.name} (${file.type}) - ${file.reason}`;
                });
                if (non3mfFiles.length > 2) {
                    errorMessage += `<br>... ‰ª•ÂèäÂè¶Â§ñ ${non3mfFiles.length - 2} ‰∏™Êñá‰ª∂`;
                }
                errorMessage += `<br><br>Âè™ËÉΩÂ§ÑÁêÜ3MFÊñá‰ª∂`;
                showErrorModal(errorMessage);
                return;
            }

            currentWebhookId = null;
            currentAutomationYaml = null;
            automationCreated = false;
            document.getElementById('progressInfo').innerHTML = '';

            // Êî∂ÈõÜÊú¨Âú∞Êñá‰ª∂
            selectedFiles = Array.from(localCheckboxes).map(cb => ({
                path: cb.value,
                name: cb.getAttribute('data-name'),
                type: 'local'
            }));
            
            // Êî∂ÈõÜÊúçÂä°Âô®Êñá‰ª∂
            const serverFiles = Array.from(serverCheckboxes).map(cb => ({
                name: cb.value,
                path: cb.getAttribute('data-path') || currentServerPath,
                type: 'server'
            }));
            
            // ÊòæÁ§∫Â§ÑÁêÜ‰∏≠ÂºπÁ™ó
            showProcessingModal(`Ê≠£Âú®ÂáÜÂ§áÂ§ÑÁêÜÈÄâ‰∏≠ÁöÑ ${selectedFiles.length + serverFiles.length} ‰∏™Êñá‰ª∂...`);
            
            try {
                // Â¶ÇÊûúÈÄâÊã©‰∫ÜÊúçÂä°Âô®Êñá‰ª∂ÔºåÂÖà‰∏ãËΩΩ
                if (serverFiles.length > 0) {
                    // ‰∏ãËΩΩÊúçÂä°Âô®Êñá‰ª∂
                    await downloadAndProcessServerFiles(serverFiles);
                }
                
                // Ëé∑ÂèñËÄóÊùêÊò†Â∞Ñ
                await loadFilamentMapping();
                
                // ÂàÜÊûêÈÄâ‰∏≠ÁöÑÊñá‰ª∂
                await analyzeSelectedFilesWithProgress();
                
                // ÂÖ≥Èó≠Â§ÑÁêÜ‰∏≠ÂºπÁ™ó
                closeProcessingModal();
                
                // ÈáçÁΩÆËá™Âä®ÂåñÂàõÂª∫Ê†áÂøó
                automationCreated = false;
                
                // ÊòæÁ§∫ÂºπÁ™ó
                document.getElementById('printQueueModal').style.display = 'block';
            } catch (error) {
                closeProcessingModal();
                showErrorModal('Â§ÑÁêÜÊñá‰ª∂Êó∂Âá∫Èîô: ' + error);
            }
        }

        // Ê£ÄÊü•ÊòØÂê¶‰∏∫3MFÊñá‰ª∂
        function is3mfFile(filename) {
            if (!filename) return false;
            return filename.toLowerCase().endsWith('.3mf');
        }

        // ‰∏ãËΩΩÂπ∂Â§ÑÁêÜÊúçÂä°Âô®Êñá‰ª∂ÔºàÊòæÁ§∫ËøõÂ∫¶Âπ∂ËΩÆËØ¢ÂêéÁ´Ø‰∏ãËΩΩÁä∂ÊÄÅÔºâ
        async function downloadAndProcessServerFiles(serverFiles) {
            // ÂàõÂª∫‰∏¥Êó∂ÁõÆÂΩï
            const tempDir = 'tempDownload';

            // Â∞ùËØïÂà∑Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÂàóË°®Ôºå‰ª•Á°Æ‰øùËÉΩÊãøÂà∞ÊúÄÊñ∞ÁöÑÊñá‰ª∂Â§ßÂ∞è
            try {
                const resp = await fetch('./api/server-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: serverFiles[0] ? serverFiles[0].path : currentServerPath })
                });
                const srvData = await resp.json();
                if (srvData && srvData.success) {
                    allServerFiles = srvData.files || allServerFiles;
                }
            } catch (e) {
                // ÂøΩÁï•Âà∑Êñ∞ÈîôËØØÔºåÁªßÁª≠‰ΩøÁî®Áé∞ÊúâÁöÑ allServerFiles
                console.warn('Âà∑Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÂàóË°®Â§±Ë¥•:', e);
            }

            // ÂáÜÂ§áÁî®‰∫éËøõÂ∫¶ÊòæÁ§∫ÁöÑÊñá‰ª∂ÂàóË°®ÔºàÂ∞ùËØï‰ªé allServerFiles ‰∏≠Ëé∑ÂèñÂ§ßÂ∞è‰ø°ÊÅØÔºâ
            const filesForProgress = serverFiles.map(f => {
                const found = allServerFiles.find(sf => sf.name === f.name);
                return {
                    name: f.name,
                    path: f.path,
                    size: found ? (found.size || 0) : 0
                };
            });

            // ÊòæÁ§∫ÊâπÈáè‰∏ãËΩΩËøõÂ∫¶ÂºπÁ™óÂπ∂ÂºÄÂßãËΩÆËØ¢
            try {
                // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™Êñá‰ª∂ÔºåÊòæÁ§∫Âçï‰∏™Êñá‰ª∂ÁöÑ‰∏ãËΩΩÂºπÁ™óÂπ∂‰ΩøÁî®ÂçïÊñá‰ª∂ËΩÆËØ¢
                if (filesForProgress.length === 1) {
                    const f = filesForProgress[0];
                    showDownloadProgressModal(f.name, f.size || 0);
                    // ÂàùÂßãÂåñÈÄüÂ∫¶ËÆ°ÁÆóÂèòÈáè
                    downloadStartTime = Date.now();
                    lastDownloadedBytes = 0;
                    startDownloadProgressPolling();
                } else {
                    showBatchDownloadProgressModal(filesForProgress);
                    startBatchDownloadProgressPolling();
                }

                // ‰ΩøÁî®ÂêéÁ´ØÁöÑÊâπÈáè‰∏ãËΩΩÊé•Âè£‰∏ÄÊ¨°ÊÄßËØ∑Ê±ÇÊâπÈáè‰∏ãËΩΩÔºå
                // ÂêéÁ´Ø‰ºöÈ°∫Â∫è‰∏ãËΩΩÊØè‰∏™Êñá‰ª∂Âπ∂Êõ¥Êñ∞ÂÖ®Â±Ä download_progressÔºåÂâçÁ´ØËΩÆËØ¢ÂèØËé∑ÂæóÊ≠£Á°ÆÁöÑÊâπÈáèËøõÂ∫¶
                try {
                    const batchRequestBody = {
                        files: filesForProgress.map(f => ({ name: f.name, path: f.path, size: f.size || 0 }))
                    };

                    const resp = await fetch('./api/batch-download-server-files', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(batchRequestBody)
                    });

                    const result = await resp.json();
                    if (result && result.success) {
                        // Â∞Ü‰∏ãËΩΩÊàêÂäüÁöÑÊñá‰ª∂Âä†ÂÖ• selectedFiles
                        (result.files || []).forEach(f => {
                            if (f.success) {
                                selectedFiles.push({ path: f.path, name: f.name, type: 'server', downloaded: true });
                            }
                        });
                    } else {
                        throw new Error(result && result.error ? result.error : 'ÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•');
                    }
                } catch (err) {
                    throw err;
                }
            } finally {
                // Êó†ËÆ∫ÊàêÂäüÊàñÂ§±Ë¥•ÔºåÈÉΩÂÅúÊ≠¢ÂØπÂ∫îÁöÑËΩÆËØ¢Âπ∂ÂÖ≥Èó≠ÂºπÁ™óÔºàËÆ©ÂêéÁª≠ÈÄªËæëÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ÈîôËØØÔºâ
                if (filesForProgress.length === 1) {
                    stopDownloadProgressPolling();
                    closeDownloadProgressModal();
                } else {
                    stopBatchDownloadProgressPolling();
                    closeBatchDownloadProgressModal();
                }
            }
        }

        // ÂàÜÊûêÈÄâ‰∏≠ÁöÑÊñá‰ª∂
        async function analyzeSelectedFilesWithProgress() {
            printQueue = [];
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                
                // Êõ¥Êñ∞Â§ÑÁêÜËøõÂ∫¶
                showProcessingModal(`Ê≠£Âú®ÂàÜÊûêÊñá‰ª∂ ${i + 1}/${selectedFiles.length}: ${file.name}`);
                
                try {
                    const response = await fetch('./api/analyze-3mf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ file_path: file.path })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        printQueue.push({
                            filename: file.name,
                            file_path: file.path,
                            preview_url: withRuntimePath(data.preview_url),
                            filament_array: data.filament_array,
                            ams_mapping: data.filament_array.map(f => (f === -1 ? -1 : -1)),
                            copies: 1,
                            timelapse: false,
                            bed_leveling: true,
                            flow_cali: true,
                            vibration_cali: true,
                            layer_inspect: false,
                            is_server_file: file.type === 'server', // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÊúçÂä°Âô®Êñá‰ª∂
                            downloaded: file.downloaded || false // Ê†áËÆ∞ÊòØÂê¶‰∏∫‰∏ãËΩΩÁöÑÊñá‰ª∂
                        });
                    } else {
                        console.error(`ÂàÜÊûêÊñá‰ª∂ ${file.name} Â§±Ë¥•: ${data.error}`);
                        // ÁªßÁª≠Â§ÑÁêÜÂÖ∂‰ªñÊñá‰ª∂Ôºå‰∏ç‰∏≠Êñ≠Êï¥‰∏™ÊµÅÁ®ã
                    }
                } catch (error) {
                    console.error(`ÂàÜÊûêÊñá‰ª∂ ${file.name} Â§±Ë¥•: ${error}`);
                    // ÁªßÁª≠Â§ÑÁêÜÂÖ∂‰ªñÊñá‰ª∂Ôºå‰∏ç‰∏≠Êñ≠Êï¥‰∏™ÊµÅÁ®ã
                }
                
                // Áü≠ÊöÇÂª∂ËøüÔºåËÆ©Áî®Êà∑ËÉΩÁúãÂà∞ËøõÂ∫¶Êõ¥Êñ∞
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Ëá™Âä®‰∏∫ÊØè‰∏™Êñá‰ª∂ÁöÑËÄóÊùêÈÄâÊã©ÊúÄÂåπÈÖçÁöÑÂèØÁî®ËÄóÊùê
            autoAssignFilaments();
            
            // Ê∏≤ÊüìÊñá‰ª∂ÈòüÂàó
            renderFileQueue();
        }

        // ÂÖ≥Èó≠ÊâìÂç∞ÈòüÂàóÈÖçÁΩÆÂºπÁ™ó
        function closePrintQueueModal() {
            document.getElementById('printQueueModal').style.display = 'none';
            currentWebhookId = null;
            currentAutomationYaml = null;
            document.getElementById('progressInfo').innerHTML = '';
            // Â¶ÇÊûúÂàõÂª∫‰∫ÜËá™Âä®ÂåñÔºåÂàôÂà∑Êñ∞ÊúçÂä°Âô®Êñá‰ª∂ÂàóË°®
            if (automationCreated) {
                setTimeout(() => {
                    refreshServerFiles();
                }, 1000);
            }
            automationCreated = false;
        }
        
        // Âä†ËΩΩËÄóÊùêÊò†Â∞Ñ
        async function loadFilamentMapping() {
            try {
                const response = await fetch('./api/get-filament-mapping');
                const data = await response.json();
                console.log('ËÄóÊùêÊò†Â∞ÑÊï∞ÊçÆ:', data);
                
                if (data.success) {
                    filamentMapping = data.filament_mapping;
                    console.log('Âä†ËΩΩÁöÑËÄóÊùêÊò†Â∞Ñ:', filamentMapping);
                } else {
                    showErrorModal('Ëé∑ÂèñËÄóÊùêÊò†Â∞ÑÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÄóÊùêÊò†Â∞ÑÈîôËØØ:', error);
                showErrorModal('Ëé∑ÂèñËÄóÊùêÊò†Â∞ÑÂ§±Ë¥•: ' + error);
            }
        }

        // Ëá™Âä®‰∏∫ËÄóÊùêÂàÜÈÖçÊúÄÂåπÈÖçÁöÑÂèØÁî®ËÄóÊùê
        function autoAssignFilaments() {
            printQueue.forEach(fileConfig => {
                if (fileConfig.filament_array && Array.isArray(fileConfig.filament_array)) {
                    fileConfig.filament_array.forEach((requiredFilament, filamentIndex) => {
                        if (requiredFilament !== -1) {
                            const bestMatch = findBestFilamentMatch(requiredFilament);
                            if (bestMatch) {
                                fileConfig.ams_mapping[filamentIndex] = bestMatch.mappingValue;
                            }
                        }
                    });
                }
            });
        }

        // ÊâæÂà∞‰∏éÈúÄÊ±ÇËÄóÊùêÊúÄÂåπÈÖçÁöÑÂèØÁî®ËÄóÊùê
        function findBestFilamentMatch(requiredFilament) {
            let bestMatch = null;
            let bestScore = Number.MAX_SAFE_INTEGER;

            // Ê£ÄÊü•ÊâÄÊúâÂèØÁî®ÁöÑËÄóÊùê
            Object.keys(filamentMapping).forEach(key => {
                const availableFilament = filamentMapping[key];
                
                // Ê£ÄÊü•ÂÖºÂÆπÊÄß
                if (checkFilamentCompatibility(requiredFilament.type, availableFilament.type)) {
                    // ËÆ°ÁÆóÈ¢úËâ≤Áõ∏‰ººÂ∫¶ÂæóÂàÜ
                    const colorScore = calculateColorSimilarity(requiredFilament.color, availableFilament.color);
                    
                    // ÊâæÂà∞Êõ¥Â∞èÁöÑËâ≤Â∑ÆÂàÜÊï∞ÔºåÊàñËÄÖËâ≤Â∑ÆÂàÜÊï∞Áõ∏Âêå‰ΩÜÊ†áÂè∑Êõ¥Â∞è
                    if (colorScore < bestScore || 
                        (colorScore === bestScore && 
                        (bestMatch === null || key < bestMatch.mappingValue))) {
                        bestScore = colorScore;
                        bestMatch = {
                            mappingValue: key === 'external' ? -1 : parseInt(key),
                            filament: availableFilament,
                            score: colorScore
                        };
                    }
                }
            });

            return bestMatch;
        }

        // ËÆ°ÁÆó‰∏§‰∏™È¢úËâ≤‰πãÈó¥ÁöÑÁõ∏‰ººÂ∫¶
        function calculateColorSimilarity(color1, color2) {
            // Â∞ÜÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤ËΩ¨Êç¢‰∏∫RGB
            const rgb1 = hexToRgb(color1);
            const rgb2 = hexToRgb(color2);
            
            if (!rgb1 || !rgb2) return Number.MAX_SAFE_INTEGER;
            
            // ËÆ°ÁÆóÊ¨ßÂá†ÈáåÂæóË∑ùÁ¶ªÔºàÂèçÂêëÔºåË∑ùÁ¶ªË∂äÂ∞èÁõ∏‰ººÂ∫¶Ë∂äÈ´òÔºâ
            const rDiff = rgb1.r - rgb2.r;
            const gDiff = rgb1.g - rgb2.g;
            const bDiff = rgb1.b - rgb2.b;
            return Math.sqrt(rDiff * rDiff + gDiff * gDiff + bDiff * bDiff);
        }

        // Â∞ÜÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤ËΩ¨Êç¢‰∏∫RGBÂØπË±°
        function hexToRgb(hex) {
            // ÁßªÈô§#Âè∑
            hex = hex.replace('#', '').trim();
            if (hex.length === 3) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            } else if (hex.length === 8) {
                hex = hex.substring(0, 6);
            }
            if (hex.length !== 6) {
                return null;
            }
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            return { r, g, b };
        }
        
        // Ê∏≤ÊüìÊñá‰ª∂ÈòüÂàó
        function renderFileQueue() {
            const fileQueue = document.getElementById('fileQueue');
            fileQueue.innerHTML = '';
            
            printQueue.forEach((fileConfig, index) => {
                const queueItem = document.createElement('div');
                queueItem.className = 'queue-item';
                queueItem.setAttribute('draggable', 'true');
                queueItem.setAttribute('data-index', index);
                
                // ËÄóÊùêÊòæÁ§∫
                let filamentsHtml = '';
                if (fileConfig.filament_array && Array.isArray(fileConfig.filament_array)) {
                    fileConfig.filament_array.forEach((filament, filamentIndex) => {
                        if (filament !== -1) {
                            const isAssigned = fileConfig.ams_mapping[filamentIndex] !== -1;
                            const requiredColor = filament.color || '#FFFFFF';
                            
                            let selectedColor = '#FFFFFF';
                            let selectedType = '';
                            let slotName = '?';
                            
                            if (isAssigned) {
                                const mapping = filamentMapping[fileConfig.ams_mapping[filamentIndex]];
                                if (mapping) {
                                    selectedColor = mapping.color || '#FFFFFF';
                                    selectedType = mapping.type || '';
                                    
                                    // ËÆ°ÁÆóÊßΩ‰ΩçÂêçÁß∞
                                    if (fileConfig.ams_mapping[filamentIndex] === -1) {
                                        slotName = 'Â§ñÊåÇÊñôÁõò';
                                    } else {
                                        const mappingValue = fileConfig.ams_mapping[filamentIndex];
                                        const amsIndex = Math.floor(mappingValue / 4) + 1;
                                        const trayIndex = (mappingValue % 4) + 1;
                                        // Â∞ÜAMSÁ¥¢ÂºïËΩ¨Êç¢‰∏∫Â≠óÊØç (1->A, 2->B, 3->C, 4->D)
                                        const amsLetter = String.fromCharCode(64 + amsIndex);
                                        slotName = `${amsLetter}${trayIndex}`;
                                    }
                                }
                            }
                            
                            // ‰∏∫Â∑≤ÂàÜÈÖçÁöÑËÄóÊùêËÆ°ÁÆóÊñáÂ≠óÈ¢úËâ≤
                            const textColor = isAssigned ? getContrastColor(selectedColor) : '#6c757d';
                            
                            filamentsHtml += `
                                <div class="filament-box-container" style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                    <div class="filament-box ${isAssigned ? 'assigned' : 'unassigned'}" 
                                        data-filament-index="${filamentIndex}"
                                        style="${isAssigned ? `--required-color: ${requiredColor}; --selected-color: ${selectedColor}; color: ${textColor};` : ''}"
                                        onclick="openFilamentModal(${index}, ${filamentIndex})">
                                        ${isAssigned ? selectedType : (filament.type || 'Unknown')}
                                    </div>
                                    ${isAssigned ? `<div class="slot-info" style="font-size: 0.55em; color: #495057; font-weight: 600; text-align: center;">${slotName}</div>` : ''}
                                </div>
                            `;
                        }
                    });
                }
                
                queueItem.innerHTML = `
                    <div class="file-preview">
                        ${fileConfig.preview_url ? 
                            `<img src="${fileConfig.preview_url}" alt="${fileConfig.filename}">` : 
                            `<div style="width: 100%; height: 120px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px; color: #6c757d;">Êó†È¢ÑËßàÂõæ</div>`
                        }
                        <button class="copy-btn" onclick="copyFileConfig(${index})">Â§çÂà∂</button>
                    </div>
                    <div class="file-config">
                        <div class="file-header">
                            <div class="config-item">
                                <label>ÊâìÂç∞‰ªΩÊï∞</label>
                                <input type="number" class="copies-input" value="${fileConfig.copies}" min="1" 
                                    onchange="updateFileConfig(${index}, 'copies', parseInt(this.value))">
                            </div>
                            <div class="config-item" style="flex: 1;">
                                <label>Êñá‰ª∂Âêç</label>
                                <span>${fileConfig.filename}</span>
                            </div>
                        </div>
                        <div class="config-row">
                            <div class="config-item">
                                <label>Âª∂Êó∂ÊëÑÂΩ±</label>
                                <label class="switch">
                                    <input type="checkbox" ${fileConfig.timelapse ? 'checked' : ''} 
                                        onchange="updateFileConfig(${index}, 'timelapse', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="config-item">
                                <label>ÁÉ≠Â∫äË∞ÉÂπ≥</label>
                                <label class="switch">
                                    <input type="checkbox" ${fileConfig.bed_leveling ? 'checked' : ''} 
                                        onchange="updateFileConfig(${index}, 'bed_leveling', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="config-item">
                                <label>ÊµÅÈáèÊ†°ÂáÜ</label>
                                <label class="switch">
                                    <input type="checkbox" ${fileConfig.flow_cali ? 'checked' : ''} 
                                        onchange="updateFileConfig(${index}, 'flow_cali', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="filaments-container">
                        <div class="filaments-title">ËÄóÊùêÈÖçÁΩÆ</div>
                        <div class="filaments-grid">
                            ${filamentsHtml}
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeFileFromQueue(${index})">ÁßªÈô§</button>
                `;
                
                // Ê∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂
                setupDragAndDrop(queueItem, index);
                
                fileQueue.appendChild(queueItem);
            });
        }

        // ËÆæÁΩÆÊãñÊãΩÂäüËÉΩ
        function setupDragAndDrop(element, index) {
            element.addEventListener('dragstart', (e) => {
                isDragging = true;
                dragSrcElement = element;
                dragStartIndex = index;
                element.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', index);
                
                // ÊòæÁ§∫ÊãñÊãΩÊªöÂä®Âå∫Âüü
                document.getElementById('dragScrollTop').style.display = 'block';
                document.getElementById('dragScrollBottom').style.display = 'block';
            });

            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                // Âè™ÊúâÂú®‰∏çÂêåÂÖÉÁ¥†‰πãÈó¥ÁßªÂä®Êó∂ÊâçÊõ¥Êñ∞
                if (element !== dragSrcElement && !element.classList.contains('drag-over')) {
                    element.classList.add('drag-over');
                    
                    // Ëé∑ÂèñÂΩìÂâçÊãñÊãΩÁöÑÂÖÉÁ¥†Á¥¢Âºï
                    const dragOverIndex = parseInt(element.getAttribute('data-index'));
                    
                    // Âè™ÊúâÂú®Á¥¢Âºï‰∏çÂêåÊó∂ÊâçÁßªÂä®ÂÖÉÁ¥†
                    if (dragStartIndex !== dragOverIndex) {
                        // ÁßªÂä®Êï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†
                        const [movedItem] = printQueue.splice(dragStartIndex, 1);
                        printQueue.splice(dragOverIndex, 0, movedItem);
                        
                        // Êõ¥Êñ∞ÊãñÊãΩËµ∑ÂßãÁ¥¢Âºï
                        dragStartIndex = dragOverIndex;
                        
                        // ÈáçÊñ∞Ê∏≤ÊüìÈòüÂàó
                        renderFileQueue();
                    }
                }
            });

            element.addEventListener('dragleave', (e) => {
                // Âè™ÊúâÂΩìÈº†Ê†áÁ¶ªÂºÄÂÖÉÁ¥†‰∏îÊ≤°ÊúâËøõÂÖ•Â≠êÂÖÉÁ¥†Êó∂ÊâçÁßªÈô§Ê†∑Âºè
                if (!element.contains(e.relatedTarget)) {
                    element.classList.remove('drag-over');
                }
            });

            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.classList.remove('drag-over');
            });

            element.addEventListener('dragend', (e) => {
                isDragging = false;
                document.querySelectorAll('.queue-item').forEach(item => {
                    item.classList.remove('dragging');
                    item.classList.remove('drag-over');
                });
                dragSrcElement = null;
                dragStartIndex = null;
                
                // ÈöêËóèÊãñÊãΩÊªöÂä®Âå∫Âüü
                document.getElementById('dragScrollTop').style.display = 'none';
                document.getElementById('dragScrollBottom').style.display = 'none';
                
                // ÂÅúÊ≠¢ÊªöÂä®
                if (dragScrollInterval) {
                    clearInterval(dragScrollInterval);
                    dragScrollInterval = null;
                }
            });
        }

        // ÊãñÊãΩÊªöÂä®ÂäüËÉΩ
        document.addEventListener('dragover', (e) => {
            if (!isDragging) return;
            
            const modalContent = document.querySelector('.modal-content');
            const modalRect = modalContent.getBoundingClientRect();
            const scrollTop = modalContent.scrollTop;
            const scrollHeight = modalContent.scrollHeight;
            const clientHeight = modalContent.clientHeight;
            
            // Ê£ÄÊü•ÊòØÂê¶Âú®È°∂ÈÉ®ÊàñÂ∫ïÈÉ®ÊªöÂä®Âå∫Âüü
            const topScrollZone = 100; // È°∂ÈÉ®ÊªöÂä®Âå∫ÂüüÈ´òÂ∫¶
            const bottomScrollZone = 100; // Â∫ïÈÉ®ÊªöÂä®Âå∫ÂüüÈ´òÂ∫¶
            
            const inTopZone = e.clientY < modalRect.top + topScrollZone;
            const inBottomZone = e.clientY > modalRect.bottom - bottomScrollZone;
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÊªöÂä®Èó¥Èöî
            if (dragScrollInterval) {
                clearInterval(dragScrollInterval);
                dragScrollInterval = null;
            }
            
            // ËÆæÁΩÆÊñ∞ÁöÑÊªöÂä®Èó¥Èöî
            if (inTopZone && scrollTop > 0) {
                dragScrollInterval = setInterval(() => {
                    modalContent.scrollTop -= 20;
                }, 50);
            } else if (inBottomZone && scrollTop < scrollHeight - clientHeight) {
                dragScrollInterval = setInterval(() => {
                    modalContent.scrollTop += 20;
                }, 50);
            }
        });
        
        // Êõ¥Êñ∞Êñá‰ª∂ÈÖçÁΩÆ
        function updateFileConfig(index, key, value) {
            if (printQueue[index]) {
                printQueue[index][key] = value;
            }
        }
        
        // Â§çÂà∂Êñá‰ª∂ÈÖçÁΩÆÔºà‰ªÖÂ§çÂà∂ÈòüÂàóÈÖçÁΩÆÔºå‰∏çÊîπÂèòÊñá‰ª∂ÂêçÊàñË∑ØÂæÑÔºâ
        function copyFileConfig(index) {
            const originalConfig = printQueue[index];
            const copiedConfig = JSON.parse(JSON.stringify(originalConfig));

            // ‰∏çÊîπÂèòÊñá‰ª∂ÂêçÔºå‰∏çÂú®Êú¨Âú∞ÊàñÊâìÂç∞Êú∫‰∏äÂàõÂª∫Êñ∞Êñá‰ª∂
            // Ê∑ªÂä†‰∏Ä‰∏™ÂÜÖÈÉ®ÈòüÂàóIDÁî®‰∫éÂâçÁ´ØÂå∫ÂàÜÔºà‰∏çÂΩ±Âìç‰∏ä‰º†Êñá‰ª∂Ôºâ
            copiedConfig._queue_id = `q_${Date.now()}_${Math.floor(Math.random()*10000)}`;

            // Â∞ÜÂ§çÂà∂ÁöÑÈÖçÁΩÆÊèíÂÖ•Âà∞ÈòüÂàó‰∏≠Ôºà‰ªçÂºïÁî®Áõ∏ÂêåÁöÑÊñá‰ª∂Ë∑ØÂæÑ/filenameÔºâ
            printQueue.splice(index + 1, 0, copiedConfig);
            renderFileQueue();
        }
        
        // ÊâìÂºÄËÄóÊùêÈÄâÊã©ÂºπÁ™ó
        function openFilamentModal(fileIndex, filamentIndex) {
            // ÂÖ≥Èó≠ÂÖ∂‰ªñÂ∑≤ÊâìÂºÄÁöÑÂºπÁ™ó
            closeAllFilamentModals();
            
            const requiredFilament = printQueue[fileIndex].filament_array[filamentIndex];
            
            if (!requiredFilament || requiredFilament === -1) {
                console.error('Êó†ÊïàÁöÑËÄóÊùêÈúÄÊ±Ç:', fileIndex, filamentIndex, requiredFilament);
                return;
            }
            
            // ÂàõÂª∫ÈÅÆÁΩ©Â±Ç
            const overlay = document.createElement('div');
            overlay.className = 'filament-modal-overlay';
            
            // ÂàõÂª∫ÂºπÁ™ó
            const modal = document.createElement('div');
            modal.className = 'filament-modal-content';
            
            // ÁªÑÁªáAMSÊï∞ÊçÆ
            const amsGroups = {};
            Object.keys(filamentMapping).forEach(key => {
                if (key !== 'external') {
                    const mappingValue = parseInt(key);
                    const amsIndex = Math.floor(mappingValue / 4) + 1;
                    const trayIndex = (mappingValue % 4) + 1;
                    
                    if (!amsGroups[amsIndex]) {
                        amsGroups[amsIndex] = [];
                    }
                    
                    amsGroups[amsIndex].push({
                        mappingValue: mappingValue,
                        trayIndex: trayIndex,
                        filament: filamentMapping[key]
                    });
                }
            });
            
            // ÁîüÊàêAMSÂàÜÁªÑHTML
            let amsHtml = '';
            Object.keys(amsGroups).sort((a, b) => a - b).forEach(amsIndex => {
                const amsSlots = amsGroups[amsIndex];
                amsSlots.sort((a, b) => a.trayIndex - b.trayIndex);
                
                // Â∞ÜAMSÁ¥¢ÂºïËΩ¨Êç¢‰∏∫Â≠óÊØç (1->A, 2->B, 3->C, 4->D)
                const amsLetter = String.fromCharCode(64 + parseInt(amsIndex)); // 65ÊòØAÁöÑASCIIÁ†Å
                
                let slotsHtml = '';
                amsSlots.forEach(slot => {
                    const isCompatible = checkFilamentCompatibility(requiredFilament.type, slot.filament.type);
                    
                    // ÂØπ‰∫é‰∏çÂÖºÂÆπÁöÑËÄóÊùêÔºå‰ΩøÁî®Âõ∫ÂÆöÊ†∑ÂºèÔºõÂØπ‰∫éÂÖºÂÆπÁöÑËÄóÊùêÔºåËÆ°ÁÆóÊñáÂ≠óÈ¢úËâ≤
                    if (!isCompatible) {
                        slotsHtml += `
                            <div class="ams-slot disabled" 
                                ${isCompatible ? `onclick="selectFilament(${fileIndex}, ${filamentIndex}, ${slot.mappingValue})"` : ''}>
                                <div class="ams-slot-number">${amsLetter}${slot.trayIndex}</div>
                                <div class="ams-slot-type">${slot.filament.type}</div>
                            </div>
                        `;
                    } else {
                        const textColor = getContrastColor(slot.filament.color);
                        slotsHtml += `
                            <div class="ams-slot" 
                                style="background-color: ${slot.filament.color}; color: ${textColor};"
                                onclick="selectFilament(${fileIndex}, ${filamentIndex}, ${slot.mappingValue})">
                                <div class="ams-slot-number">${amsLetter}${slot.trayIndex}</div>
                                <div class="ams-slot-type">${slot.filament.type}</div>
                            </div>
                        `;
                    }
                });
                
                amsHtml += `
                    <div class="filament-section ams-group">
                        <div class="filament-section-title">AMS ${amsIndex} (${amsLetter})</div>
                        <div class="ams-grid">
                            ${slotsHtml}
                        </div>
                    </div>
                `;
            });
            
            // ÁîüÊàêÂ§ñÊåÇÊñôÁõòHTML
            let externalHtml = '';
            if (filamentMapping.external) {
                const isCompatible = checkFilamentCompatibility(requiredFilament.type, filamentMapping.external.type);
                
                // ÂØπ‰∫é‰∏çÂÖºÂÆπÁöÑËÄóÊùêÔºå‰ΩøÁî®Âõ∫ÂÆöÊ†∑ÂºèÔºõÂØπ‰∫éÂÖºÂÆπÁöÑËÄóÊùêÔºåËÆ°ÁÆóÊñáÂ≠óÈ¢úËâ≤
                if (!isCompatible) {
                    externalHtml = `
                        <div class="filament-section">
                            <div class="filament-section-title">Â§ñÊåÇÊñôÁõò</div>
                            <div class="ams-grid" style="grid-template-columns: 1fr;">
                                <div class="external-spool disabled">
                                    <div>Â§ñÊåÇÊñôÁõò</div>
                                    <div class="ams-slot-type">${filamentMapping.external.type}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const textColor = getContrastColor(filamentMapping.external.color);
                    externalHtml = `
                        <div class="filament-section">
                            <div class="filament-section-title">Â§ñÊåÇÊñôÁõò</div>
                            <div class="ams-grid" style="grid-template-columns: 1fr;">
                                <div class="external-spool" 
                                    style="background-color: ${filamentMapping.external.color}; color: ${textColor};"
                                    onclick="selectFilament(${fileIndex}, ${filamentIndex}, 'external')">
                                    <div>Â§ñÊåÇÊñôÁõò</div>
                                    <div class="ams-slot-type">${filamentMapping.external.type}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÂèØÁî®ÁöÑËÄóÊùêÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
            if (!amsHtml && !externalHtml) {
                amsHtml = '<div style="text-align: center; padding: 20px; color: #6c757d;">Ê≤°ÊúâÂèØÁî®ÁöÑËÄóÊùêÈÖçÁΩÆ</div>';
            }
            
            modal.innerHTML = `
                <div class="filament-modal-header">
                    <h3 class="filament-modal-title">ÈÄâÊã©ËÄóÊùê</h3>
                    <button onclick="closeAllFilamentModals()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6c757d;">&times;</button>
                </div>
                <div class="filament-requirement">
                    <strong>ÈúÄÊ±ÇËÄóÊùê:</strong> ${requiredFilament.settings_id || requiredFilament.type} 
                    <div class="requirement-color" style="background-color: ${requiredFilament.color};"></div>
                </div>
                ${amsHtml}
                ${externalHtml}
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // ÁÇπÂáªÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠ÂºπÁ™ó
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeAllFilamentModals();
                }
            });
        }

        // Ê†πÊçÆËÉåÊôØËâ≤Ëé∑ÂèñÂØπÊØîÂ∫¶ÂêàÈÄÇÁöÑÊñáÂ≠óÈ¢úËâ≤
        function getContrastColor(hexColor) {
            // ÁßªÈô§#Âè∑
            hexColor = hexColor.replace('#', '');
            
            // ËΩ¨Êç¢‰∏∫RGB
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            
            // ËÆ°ÁÆó‰∫ÆÂ∫¶ (‰ΩøÁî®W3CÁÆóÊ≥ï)
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            // Ê†πÊçÆ‰∫ÆÂ∫¶ËøîÂõûÈªëËâ≤ÊàñÁôΩËâ≤
            return brightness > 128 ? '#000000' : '#FFFFFF';
        }

        // ÂÖ≥Èó≠ÊâÄÊúâËÄóÊùêÈÄâÊã©ÂºπÁ™ó
        function closeAllFilamentModals() {
            const overlays = document.querySelectorAll('.filament-modal-overlay');
            overlays.forEach(overlay => overlay.remove());
        }
        
        // Ê£ÄÊü•ËÄóÊùêÂÖºÂÆπÊÄß
        function checkFilamentCompatibility(requiredType, availableType) {
            if (!requiredType || !availableType) return false;
            
            // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂåπÈÖçÂºÄÂ§¥ÈÉ®ÂàÜ
            const requiredBase = requiredType.match(/^[A-Za-z]+/)?.[0] || requiredType;
            const availableBase = availableType.match(/^[A-Za-z]+/)?.[0] || availableType;
            
            return requiredBase === availableBase;
        }
        
        // ÈÄâÊã©ËÄóÊùê
        function selectFilament(fileIndex, filamentIndex, mappingKey) {
            console.log('ÈÄâÊã©ËÄóÊùê:', fileIndex, filamentIndex, mappingKey);
            
            if (printQueue[fileIndex]) {
                // ËΩ¨Êç¢mappingKey‰∏∫Êï∞Â≠óÔºàÂ¶ÇÊûúÊòØAMSÊßΩ‰ΩçÔºâ
                const mappedValue = mappingKey === 'external' ? -1 : parseInt(mappingKey);
                printQueue[fileIndex].ams_mapping[filamentIndex] = mappedValue;
                
                console.log('Êõ¥Êñ∞ÂêéÁöÑAMSÊò†Â∞Ñ:', printQueue[fileIndex].ams_mapping);
                
                closeAllFilamentModals();
                renderFileQueue();
            }
        }
        
        // ‰ªéÈòüÂàó‰∏≠ÁßªÈô§Êñá‰ª∂
        function removeFileFromQueue(index) {
            if (confirm(`Á°ÆÂÆöË¶Å‰ªéÊâìÂç∞ÈòüÂàó‰∏≠ÁßªÈô§Êñá‰ª∂ "${printQueue[index].filename}" ÂêóÔºü`)) {
                printQueue.splice(index, 1);
                renderFileQueue();
                
                // Â¶ÇÊûúÈòüÂàó‰∏∫Á©∫ÔºåÂÖ≥Èó≠ÂºπÁ™ó
                if (printQueue.length === 0) {
                    closePrintQueueModal();
                }
            }
        }

        // Â∫îÁî®‰∏ÄÈîÆÈÖçÁΩÆÔºàÂÆûÊó∂Êõ¥Êñ∞Ôºâ
        function applyQuickConfig(key, value) {
            console.log('Â∫îÁî®‰∏ÄÈîÆÈÖçÁΩÆ:', key, value);
            
            printQueue.forEach(fileConfig => {
                fileConfig[key] = value;
            });
            
            // ÈáçÊñ∞Ê∏≤ÊüìÈòüÂàó‰ª•Êõ¥Êñ∞UI
            renderFileQueue();
        }
        
        // ÂàõÂª∫Ëá™Âä®Âåñ
        async function createAutomation() {
            // È™åËØÅÊâÄÊúâÊñá‰ª∂ÁöÑËÄóÊùêÈÖçÁΩÆ
            for (const fileConfig of printQueue) {
                for (let i = 0; i < fileConfig.filament_array.length; i++) {
                    if (fileConfig.filament_array[i] !== -1 && fileConfig.ams_mapping[i] === -1) {
                        showErrorModal(`Êñá‰ª∂"${fileConfig.filename}"ÊúâÈúÄÊ±ÇËÄóÊùêÊú™ÂàÜÈÖç`);
                        return;
                    }
                }
            }
            
            // ÊòæÁ§∫Â§ÑÁêÜ‰∏≠ÂºπÁ™ó
            showProcessingModal('Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂Âπ∂ÂàõÂª∫Ëá™Âä®Âåñ...');
            // ÂºÄÂßãËΩÆËØ¢‰∏ä‰º†ËøõÂ∫¶
            startProgressPolling();
            
            try {
                // Á≠õÈÄâÂá∫ÈúÄË¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂ÔºàÂè™‰∏ä‰º†Êú¨Âú∞Êñá‰ª∂ÔºåË∑≥ËøáÊúçÂä°Âô®Êñá‰ª∂Ôºâ
                const filesToUpload = printQueue.filter(file => !file.is_server_file || !file.downloaded);
                
                // ÂáÜÂ§áÂéªÈáçÁöÑ‰∏ä‰º†Êñá‰ª∂ÂàóË°®ÔºàÊåâ file_path ÂéªÈáçÔºâÔºå‰øùËØÅÁõ∏ÂêåÁöÑÁâ©ÁêÜÊñá‰ª∂Âè™‰∏ä‰º†‰∏ÄÊ¨°
                const uploadMap = new Map();
                for (const fileConfig of printQueue) {
                    // Ë∑≥ËøáÂ∑≤Ê†áËÆ∞‰∏∫ÊúçÂä°Âô®Êñá‰ª∂‰∏îÂ∑≤‰∏ãËΩΩÁöÑÔºàÁî±ÂêéÁ´ØÊéßÂà∂Ôºâ
                    if (fileConfig.is_server_file && fileConfig.downloaded) continue;
                    const fp = fileConfig.file_path || fileConfig.path || fileConfig.filePath || null;
                    if (!fp) continue;
                    if (!uploadMap.has(fp)) {
                        uploadMap.set(fp, { file_path: fp, filename: fileConfig.filename });
                    }
                }

                const files_to_upload = Array.from(uploadMap.values());

                const response = await fetch('./api/create-automation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        print_queue: printQueue,
                        upload_path: currentServerPath,
                        skip_server_files: true, // ÂëäËØâÂêéÁ´ØË∑≥ËøáÊúçÂä°Âô®Êñá‰ª∂ÁöÑ‰∏ä‰º†
                        files_to_upload: files_to_upload // ÊòéÁ°ÆÂëäËØâÂêéÁ´ØÊåâËøô‰∏™ÂàóË°®‰∏ä‰º†ÔºàÂéªÈáçÔºâ
                    })
                });
                
                const data = await response.json();
                // ËÆæÁΩÆËá™Âä®ÂåñÂàõÂª∫Ê†áÂøó
                automationCreated = true;
                // ÂÅúÊ≠¢ËøõÂ∫¶ËΩÆËØ¢
                stopProgressPolling();
                
                if (data.success) {
                    currentWebhookId = data.webhook_id;
                    currentAutomationYaml = data.automation_yaml;
                    // ÂÖ≥Èó≠Â§ÑÁêÜ‰∏≠ÂºπÁ™ó
                    closeProcessingModal();
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    document.getElementById('progressInfo').innerHTML = '<span style="color: #27ae60;">‚úì ‰∏ä‰º†Âπ∂ÂàõÂª∫Ëá™Âä®ÂåñÊàêÂäüÔºåÂèØ‰ª•ÂºÄÂßãÊâìÂç∞</span>';
                    showSuccessModal('Êñá‰ª∂Â∑≤‰∏ä‰º†Âà∞ÊâìÂç∞Êú∫<br>Ëá™Âä®ÂåñÂàõÂª∫ÂëΩ‰ª§Â∑≤ÂèëÂá∫<br>ÂèØ‰ª•ÂºÄÂßãÊâìÂç∞‰∫Ü', true);
                } else {
                    currentAutomationYaml = data.automation_yaml;
                    closeProcessingModal();
                    showErrorModal('ÂàõÂª∫Ëá™Âä®ÂåñÂ§±Ë¥•: ' + data.error, true);
                }
            } catch (error) {
                stopProgressPolling();
                closeProcessingModal();
                showErrorModal('ÂàõÂª∫Ëá™Âä®ÂåñÂ§±Ë¥•: ' + error);
            }
        }

        // ÂºÄÂßãÊâìÂç∞
        async function startPrint() {
            if (!currentWebhookId) {
                showErrorModal('ËØ∑ÂÖàÂàõÂª∫Ëá™Âä®Âåñ');
                return;
            }
            
            // ÊòæÁ§∫Â§ÑÁêÜ‰∏≠ÂºπÁ™ó
            showProcessingModal('Ê≠£Âú®ÂêØÂä®ÊâìÂç∞‰ªªÂä°...');
            
            try {
                const response = await fetch('./api/start-print', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ webhook_id: currentWebhookId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ÂÖ≥Èó≠Â§ÑÁêÜ‰∏≠ÂºπÁ™ó
                    closeProcessingModal();
                    
                    // ÊòæÁ§∫ÊàêÂäüÂºπÁ™ó
                    showSuccessModal('ÊâìÂç∞‰ªªÂä°Â∑≤ÂºÄÂßãÔºÅHAËá™Âä®ÂåñÂºÄÂßãËøêË°å„ÄÇ');
                } else {
                    closeProcessingModal();
                    showErrorModal('ÂºÄÂßãÊâìÂç∞Â§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                closeProcessingModal();
                showErrorModal('ÂºÄÂßãÊâìÂç∞Â§±Ë¥•: ' + error);
            }
        }

        // Â§çÂà∂Ëá™Âä®ÂåñYAML
        function copyAutomationYaml() {
            if (!currentAutomationYaml) {
                showErrorModal('Ê≤°ÊúâÂèØÁî®ÁöÑËá™Âä®ÂåñYAMLÊï∞ÊçÆ');
                return;
            }
            
            // Â∞ÜYAMLÂØπË±°ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
            const yamlString = JSON.stringify(currentAutomationYaml, null, 2);
            
            // ‰ΩøÁî®Clipboard APIÂ§çÂà∂Âà∞Ââ™Ë¥¥Êùø
            navigator.clipboard.writeText(yamlString).then(() => {
                // ÊòæÁ§∫Â§çÂà∂ÊàêÂäüÂèçÈ¶à - ÂêåÊó∂Êõ¥Êñ∞‰∏§‰∏™ÊåâÈíÆ
                const successCopyBtn = document.getElementById('copyYamlBtn');
                const errorCopyBtn = document.getElementById('errorCopyYamlBtn');
                const originalText = 'üìã Â§çÂà∂Ëá™Âä®Âåñyaml';
                
                if (successCopyBtn) {
                    successCopyBtn.textContent = '‚úÖ Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø';
                    successCopyBtn.classList.add('copied');
                }
                
                if (errorCopyBtn) {
                    errorCopyBtn.textContent = '‚úÖ Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø';
                    errorCopyBtn.classList.add('copied');
                }
                
                // 3ÁßíÂêéÊÅ¢Â§çÂéüÁä∂
                setTimeout(() => {
                    if (successCopyBtn) {
                        successCopyBtn.textContent = originalText;
                        successCopyBtn.classList.remove('copied');
                    }
                    if (errorCopyBtn) {
                        errorCopyBtn.textContent = originalText;
                        errorCopyBtn.classList.remove('copied');
                    }
                }, 3000);
                
            }).catch(err => {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                showErrorModal('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÄâÊã©ÊñáÊú¨Â§çÂà∂');
                
                // Â§áÁî®ÊñπÊ°àÔºöÂàõÂª∫‰∏¥Êó∂ÊñáÊú¨Âå∫ÂüüËÆ©Áî®Êà∑ÊâãÂä®Â§çÂà∂
                const textArea = document.createElement('textarea');
                textArea.value = yamlString;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        // ÂºÄÂßãËΩÆËØ¢‰∏ä‰º†ËøõÂ∫¶
        function startProgressPolling() {
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑËΩÆËØ¢
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
            }
            
            // ÊØè500ÊØ´ÁßíËé∑Âèñ‰∏ÄÊ¨°ËøõÂ∫¶
            progressPollingInterval = setInterval(fetchUploadProgress, 500);
            lastProgressUpdate = Date.now();
        }

        // ÂÅúÊ≠¢ËΩÆËØ¢‰∏ä‰º†ËøõÂ∫¶
        function stopProgressPolling() {
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
        }

        // Ëé∑Âèñ‰∏ä‰º†ËøõÂ∫¶
        async function fetchUploadProgress() {
            try {
                const response = await fetch('./api/upload-progress');
                const progress = await response.json();
                
                // Êõ¥Êñ∞Â§ÑÁêÜ‰∏≠ÂºπÁ™óÁöÑÊòæÁ§∫
                updateProcessingModal(progress);
                
                // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
                lastProgressUpdate = Date.now();
                
                // Â¶ÇÊûú‰∏ä‰º†ÂÆåÊàêÊàñÂá∫ÈîôÔºåÂÅúÊ≠¢ËΩÆËØ¢
                if (progress.status === 'success' || progress.status === 'error' || progress.status === 'completed') {
                    stopProgressPolling();
                }
                
                // Â¶ÇÊûúË∂ÖËøá30ÁßíÊ≤°ÊúâÊõ¥Êñ∞ÔºåËÆ§‰∏∫ËøûÊé•ÂèØËÉΩÂ∑≤Êñ≠ÂºÄ
                if (Date.now() - lastProgressUpdate > 30000) {
                    console.warn('ËøõÂ∫¶Êõ¥Êñ∞Ë∂ÖÊó∂ÔºåÂèØËÉΩËøûÊé•Â∑≤Êñ≠ÂºÄ');
                    stopProgressPolling();
                }
            } catch (error) {
                console.error('Ëé∑Âèñ‰∏ä‰º†ËøõÂ∫¶Â§±Ë¥•:', error);
                // ‰∏çÂÅúÊ≠¢ËΩÆËØ¢ÔºåÂõ†‰∏∫ÂèØËÉΩÊòØ‰∏¥Êó∂ÁΩëÁªúÈóÆÈ¢ò
            }
        }

        // Êõ¥Êñ∞Â§ÑÁêÜ‰∏≠ÂºπÁ™óÊòæÁ§∫
        function updateProcessingModal(progress) {
            const processingMessage = document.getElementById('processingModalMessage');
            
            if (!processingMessage) return;
            
            let message = '';
            let progressBar = '';
            
            switch (progress.status) {
                case 'starting':
                    message = 'ÂáÜÂ§áÂºÄÂßã‰∏ä‰º†Êñá‰ª∂...';
                    break;
                case 'uploading':
                    if (progress.current_file) {
                        const currentFileIndex = progress.current_file_index + 1;
                        const totalFiles = progress.total_files;
                        const fileProgress = progress.progress.toFixed(1);
                        if(currentFileIndex > totalFiles){
                            currentFileIndex = totalFiles;
                        }
                        message = `Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂ ${currentFileIndex}/${totalFiles}<br>`;
                        
                        if (progress.message) {
                            message += `<br>${progress.message}`;
                        }
                        
                        // Ê∑ªÂä†ËøõÂ∫¶Êù°
                        progressBar = `
                            <div style="margin: 15px 0; background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(135deg, #3498db, #2980b9); width: ${fileProgress}%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">
                                    ${fileProgress}%
                                </div>
                            </div>
                        `;
                    }
                    break;
                case 'completed':
                    message = 'ÊâÄÊúâÊñá‰ª∂‰∏ä‰º†ÂÆåÊàêÔºåÊ≠£Âú®ÂàõÂª∫Ëá™Âä®Âåñ...';
                    break;
                case 'success':
                    message = 'Ëá™Âä®ÂåñÂàõÂª∫ÊàêÂäüÔºÅ';
                    break;
                case 'error':
                    message = `‰∏ä‰º†ËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ: ${progress.message}`;
                    break;
                default:
                    message = 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂Âπ∂ÂàõÂª∫Ëá™Âä®Âåñ...';
            }
            
            processingMessage.innerHTML = message + progressBar;
        }

        // Âú®È°µÈù¢Âç∏ËΩΩÊó∂ÂÅúÊ≠¢ËΩÆËØ¢
        window.addEventListener('beforeunload', function() {
            stopProgressPolling();
            stopDownloadProgressPolling();
            stopBatchDownloadProgressPolling();
        });

        // ÊòæÁ§∫ÈîôËØØÂºπÁ™ó
        function showErrorModal(message, showCopyButton = false) {
            const errorModal = document.getElementById('errorModal');
            const errorMessage = document.getElementById('errorModalMessage');
            const errorCopyYamlBtn = document.getElementById('errorCopyYamlBtn');
            errorMessage.innerHTML = message;
            if (showCopyButton && currentAutomationYaml) {
                errorCopyYamlBtn.style.display = 'block';
            } else {
                errorCopyYamlBtn.style.display = 'none';
            }
            errorModal.style.display = 'flex';
        }

        // ÂÖ≥Èó≠ÈîôËØØÂºπÁ™ó
        function closeErrorModal() {
            const errorModal = document.getElementById('errorModal');
            const errorCopyYamlBtn = document.getElementById('errorCopyYamlBtn');
            errorModal.style.display = 'none';
            errorCopyYamlBtn.textContent = 'üìã Â§çÂà∂Ëá™Âä®Âåñyaml';
            errorCopyYamlBtn.classList.remove('copied');
            errorCopyYamlBtn.style.display = 'none';
        }

        // ÊòæÁ§∫Â§ÑÁêÜ‰∏≠ÂºπÁ™ó
        function showProcessingModal(message) {
            const processingModal = document.getElementById('processingModal');
            const processingMessage = document.getElementById('processingModalMessage');
            
            // Âà§Êñ≠messageÊòØÁ∫ØÊñáÊú¨ËøòÊòØHTML
            if (typeof message === 'string' && message.includes('<')) {
                // Â¶ÇÊûúÊòØHTMLÂÜÖÂÆπÔºåÁõ¥Êé•ËÆæÁΩÆinnerHTML
                processingMessage.innerHTML = message;
            } else {
                // Â¶ÇÊûúÊòØÁ∫ØÊñáÊú¨ÔºåÂàõÂª∫ËøõÂ∫¶ËØ¶ÊÉÖÂå∫Âüü
                processingMessage.innerHTML = `
                    <div>${message}</div>
                    <div id="progressDetails" style="margin-top: 15px; font-size: 0.9em; color: #6c757d;">
                        <!-- ËøõÂ∫¶ËØ¶ÊÉÖÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÊõ¥Êñ∞ -->
                    </div>
                `;
            }
            
            processingModal.style.display = 'flex';
        }

        // ÂÖ≥Èó≠Â§ÑÁêÜ‰∏≠ÂºπÁ™ó
        function closeProcessingModal() {
            const processingModal = document.getElementById('processingModal');
            processingModal.style.display = 'none';
        }

        // ÊòæÁ§∫ÊàêÂäüÂºπÁ™ó
        function showSuccessModal(message, showCopyButton = false) {
            const successModal = document.getElementById('successModal');
            const successMessage = document.getElementById('successModalMessage');
            const copyYamlBtn = document.getElementById('copyYamlBtn');
            
            successMessage.innerHTML = message;
            
            // Ê†πÊçÆÂèÇÊï∞ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫Â§çÂà∂ÊåâÈíÆ
            if (showCopyButton && currentAutomationYaml) {
                copyYamlBtn.style.display = 'block';
            } else {
                copyYamlBtn.style.display = 'none';
            }
            
            successModal.style.display = 'flex';
        }

        // ÂÖ≥Èó≠ÊàêÂäüÂºπÁ™ó
        function closeSuccessModal() {
            const successModal = document.getElementById('successModal');
            successModal.style.display = 'none';
            
            // ÈáçÁΩÆÂ§çÂà∂ÊåâÈíÆÁä∂ÊÄÅ
            const copyBtn = document.getElementById('copyYamlBtn');
            copyBtn.textContent = 'üìã Â§çÂà∂Ëá™Âä®Âåñyaml';
            copyBtn.classList.remove('copied');
            copyBtn.style.display = 'none';
        }

        // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('errorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeErrorModal();
            }
        });

        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });

        document.getElementById('configModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfigModal();
            }
        });

    </script>
</body>
</html>